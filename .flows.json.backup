[{"id":"614e30cb.432cb8","type":"tab","label":"Report Main","disabled":false,"info":""},{"id":"7153aef6.c56e78","type":"tab","label":"Cache1","disabled":false,"info":""},{"id":"8f6ffea1.82b41","type":"tab","label":"Cache2","disabled":false,"info":""},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Cache1 MSSQL","server":"{{{CACHE1_DATABASE_HOST}}}","port":"{{{CACHE1_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{CACHE1_DATABASE_DB}}}","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Report MSSQL","server":"{{{REPORT_DATABASE_HOST}}}","port":"{{{REPORT_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{REPORT_DATABASE_DB}}}","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"81898769.b5aff8","type":"nats-streaming-server","server":"gravity-report-nats","port":"4222","cluster":"external-stan"},{"id":"9610aff8.a70458","type":"redis-config","name":"redis-cluster:6379","options":"redis://redis-cluster:6379","cluster":false,"optionsType":"str"},{"id":"99212330.723e98","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"SendRecordReplyProduct","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"report-atomic-sendreply-0003","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-sendreply-0003","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":290,"y":2840,"wires":[["a0774be.57d4a38"]]},{"id":"a0774be.57d4a38","type":"json","z":"614e30cb.432cb8","name":"","property":"payload","action":"","pretty":false,"x":570,"y":2840,"wires":[["2fe2c718.3ce1d"]]},{"id":"4853b82f.2c1008","type":"json","z":"614e30cb.432cb8","name":"","property":"payload","action":"","pretty":false,"x":530,"y":1780,"wires":[["a32e65ea.f8ba98","e03ce2c1.02ca1"]]},{"id":"416a0cbf.2caedc","type":"function","z":"614e30cb.432cb8","name":"Convert Insert SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1510,"y":1400,"wires":[["45a60f20.434178","1df7eb99.7a1914"]]},{"id":"45a60f20.434178","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1820,"y":1300,"wires":[]},{"id":"1df7eb99.7a1914","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [NBPReport].[dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [NBPReport].[dbo].[send_record]                                                                                                                AS send_record,\n        [NBPReport].[dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1820,"y":1400,"wires":[["15bf858d.895d2a"]]},{"id":"894f33e7.c272c8","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2670,"y":1200,"wires":[]},{"id":"9ae22d19.db31a","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2420,"y":1260,"wires":[["894f33e7.c272c8","9840cca0.f5e53"],[]]},{"id":"9840cca0.f5e53","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2650,"y":1260,"wires":[]},{"id":"15bf858d.895d2a","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2160,"y":1260,"wires":[["9ae22d19.db31a","96687b7b.110868"]]},{"id":"5e733dbf.2ab56c","type":"function","z":"614e30cb.432cb8","name":"Convert Update SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":1780,"wires":[["1428463.3e0b63a","32053f8c.c797a"]]},{"id":"1428463.3e0b63a","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1860,"y":1680,"wires":[]},{"id":"32053f8c.c797a","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1860,"y":1780,"wires":[["250f7221.5d6be6"]]},{"id":"720bc634.ca06f","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2730,"y":1720,"wires":[]},{"id":"6400e7f.be1b098","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2480,"y":1780,"wires":[["720bc634.ca06f","c0e5a995.394a68"],[]]},{"id":"c0e5a995.394a68","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2710,"y":1780,"wires":[]},{"id":"250f7221.5d6be6","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2220,"y":1780,"wires":[["6400e7f.be1b098","3fa1c4eb.479a34"]]},{"id":"f9a1e260.adf7c","type":"function","z":"614e30cb.432cb8","name":"Convert Delete SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.payload.send_time = convert_datetime(msg.payload.send_time)\nmsg.payload.expire_time = convert_datetime(msg.payload.expire_time)\nmsg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\nmsg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\nmsg.payload.dr_time = convert_datetime(msg.payload.dr_time)\nmsg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1610,"y":2120,"wires":[["9a20ee81.864b2","c5a4e075.9f2bc"]]},{"id":"9a20ee81.864b2","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1900,"y":2040,"wires":[]},{"id":"c5a4e075.9f2bc","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1900,"y":2120,"wires":[["2a85354b.94b5d2"]]},{"id":"976be76.546b998","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2810,"y":2060,"wires":[]},{"id":"1e29f584.412b4a","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2560,"y":2120,"wires":[["976be76.546b998","f13e12bb.5f506"],[]]},{"id":"f13e12bb.5f506","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2790,"y":2120,"wires":[]},{"id":"2a85354b.94b5d2","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2300,"y":2120,"wires":[["1e29f584.412b4a","e5fd1e7d.7fbc9"]]},{"id":"14ef2c68.517584","type":"function","z":"614e30cb.432cb8","name":"Convert Insert SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1340,"y":2640,"wires":[["44b9ef63.a5a7e","89600fe7.328888"]]},{"id":"44b9ef63.a5a7e","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2540,"wires":[]},{"id":"d44b5151.e51ce8","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2550,"y":2580,"wires":[]},{"id":"b04af07f.77b0b","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2300,"y":2640,"wires":[["d44b5151.e51ce8","47dfd36.66d3bac"],[]]},{"id":"75611b29.e6039c","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2020,"y":2540,"wires":[]},{"id":"47dfd36.66d3bac","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2530,"y":2640,"wires":[]},{"id":"18634ca8.e72dbb","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"Insert Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"Insert Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":2640,"wires":[["b04af07f.77b0b","9121192.861f468"]]},{"id":"98e36337.465e1","type":"function","z":"614e30cb.432cb8","name":"Convert Update SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":2840,"wires":[["dd90e772.d28e7","3811f2a2.a1f556"]]},{"id":"dd90e772.d28e7","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2740,"wires":[]},{"id":"598dba1a.47e914","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2510,"y":2780,"wires":[]},{"id":"d22bfa52.32c5f","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2260,"y":2840,"wires":[["598dba1a.47e914","94b1a069.8f83a"],[]]},{"id":"b00b68c4.8b94c","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2000,"y":2740,"wires":[]},{"id":"94b1a069.8f83a","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2490,"y":2840,"wires":[]},{"id":"d76401fa.b070e","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2000,"y":2840,"wires":[["d22bfa52.32c5f","1af123ed.d5d27c"]]},{"id":"52ce9a54.50cee4","type":"function","z":"614e30cb.432cb8","name":"Convert Delete SendRecordReply Payload","func":"\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload2 = msg.payload\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":3040,"wires":[["546c86f6.9aa6f","c0b38006.fe02d8"]]},{"id":"546c86f6.9aa6f","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2940,"wires":[]},{"id":"5a8a0539.7df364","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2550,"y":2980,"wires":[]},{"id":"b00645d9.3e8db8","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2300,"y":3040,"wires":[["5a8a0539.7df364","5cc0630.96b3a9c"],[]]},{"id":"da5464f0.d784a8","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1980,"y":2940,"wires":[]},{"id":"5cc0630.96b3a9c","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2530,"y":3040,"wires":[]},{"id":"a24f1b0f.0c6cf","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":3040,"wires":[["b00645d9.3e8db8","c9dcf942.4870c8"]]},{"id":"96687b7b.110868","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2440,"y":1180,"wires":[]},{"id":"3fa1c4eb.479a34","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2500,"y":1700,"wires":[]},{"id":"e5fd1e7d.7fbc9","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2560,"y":2060,"wires":[]},{"id":"9121192.861f468","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2300,"y":2540,"wires":[]},{"id":"1af123ed.d5d27c","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2280,"y":2780,"wires":[]},{"id":"c9dcf942.4870c8","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2260,"y":2940,"wires":[]},{"id":"a32e65ea.f8ba98","type":"switch","z":"614e30cb.432cb8","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":900,"y":1780,"wires":[["416a0cbf.2caedc"],["416a0cbf.2caedc"],["5e733dbf.2ab56c"],["f9a1e260.adf7c"]]},{"id":"2fe2c718.3ce1d","type":"switch","z":"614e30cb.432cb8","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":820,"y":2840,"wires":[["14ef2c68.517584"],["14ef2c68.517584"],["98e36337.465e1"],["52ce9a54.50cee4"]]},{"id":"e03ce2c1.02ca1","type":"debug","z":"614e30cb.432cb8","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":1660,"wires":[]},{"id":"1f953ccc.2f2c8b","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"Send Record Product","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"report-atomic-sendrecord-0003","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-sendrecord-0003","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":200,"y":1780,"wires":[["4853b82f.2c1008"]]},{"id":"89600fe7.328888","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [dbo].[send_record]                                                                                                                AS send_record,\n        [dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        \n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1680,"y":2620,"wires":[[]]},{"id":"3811f2a2.a1f556","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1700,"y":2840,"wires":[[]]},{"id":"c0b38006.fe02d8","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1700,"y":3060,"wires":[["a24f1b0f.0c6cf"]]},{"id":"48f11524.1999dc","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"Send Record","server":"81898769.b5aff8","channel":"rowData.source.SendProduct","clientID":"report-atomic-0002","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0002","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"30","x":310,"y":640,"wires":[["bf0a3ff8.4bf16"]]},{"id":"bf0a3ff8.4bf16","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"","x":560,"y":720,"wires":[]},{"id":"799af8c.ff65808","type":"nats-streaming-subscribe","z":"7153aef6.c56e78","name":"SendRecordReplyProduct","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"cache1-atomic-sendreply-0001","start":"all","start_option":"","durable":true,"durable_name":"cache1-atomic-sendreply-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":1750,"y":2320,"wires":[["d5dbb218.4329c"]]},{"id":"d5dbb218.4329c","type":"json","z":"7153aef6.c56e78","name":"","property":"payload","action":"","pretty":false,"x":2030,"y":2320,"wires":[["b93cd733.bfed68"]]},{"id":"97868fc.3ad64f","type":"json","z":"7153aef6.c56e78","name":"","property":"payload","action":"","pretty":false,"x":1990,"y":1260,"wires":[["cd65d825.b84ae8","88b494de.00eb98"]]},{"id":"3eb28ed5.f03fd2","type":"function","z":"7153aef6.c56e78","name":"Convert Insert SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2970,"y":880,"wires":[["b76a8af8.c9ccb8","73e27af4.9423dc"]]},{"id":"b76a8af8.c9ccb8","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":3280,"y":780,"wires":[]},{"id":"73e27af4.9423dc","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [NBPReport].[dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [NBPReport].[dbo].[send_record]                                                                                                                AS send_record,\n        [NBPReport].[dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3280,"y":880,"wires":[["6d72f11f.f400c"]]},{"id":"4f4e96f2.32f9e","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4130,"y":680,"wires":[]},{"id":"5439957c.95946c","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3880,"y":740,"wires":[["4f4e96f2.32f9e","fafd29c3.31b95"],[]]},{"id":"fafd29c3.31b95","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":4110,"y":740,"wires":[]},{"id":"6d72f11f.f400c","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3620,"y":740,"wires":[["5439957c.95946c","43179385.98c52c"]]},{"id":"dddf8ef1.c21f98","type":"function","z":"7153aef6.c56e78","name":"Convert Update SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3010,"y":1260,"wires":[["211211c5.eae2de","297bdc10.ae693c"]]},{"id":"211211c5.eae2de","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":3320,"y":1160,"wires":[]},{"id":"297bdc10.ae693c","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3320,"y":1260,"wires":[["ef232657.c5ef08"]]},{"id":"33e21873.04f86","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4190,"y":1200,"wires":[]},{"id":"24388628.258aea","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3940,"y":1260,"wires":[["33e21873.04f86","69452f4.6f1e7d"],[]]},{"id":"69452f4.6f1e7d","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":4170,"y":1260,"wires":[]},{"id":"ef232657.c5ef08","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3680,"y":1260,"wires":[["24388628.258aea","72c60f3b.c40a5"]]},{"id":"8f3eb139.81bc18","type":"function","z":"7153aef6.c56e78","name":"Convert Delete SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.payload.send_time = convert_datetime(msg.payload.send_time)\nmsg.payload.expire_time = convert_datetime(msg.payload.expire_time)\nmsg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\nmsg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\nmsg.payload.dr_time = convert_datetime(msg.payload.dr_time)\nmsg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3070,"y":1600,"wires":[["3837c1bf.84a066","9f6a6a41.99f8a"]]},{"id":"3837c1bf.84a066","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":3360,"y":1520,"wires":[]},{"id":"9f6a6a41.99f8a","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3360,"y":1600,"wires":[["d56db3b7.22bf28"]]},{"id":"46d8969d.9b812","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4270,"y":1540,"wires":[]},{"id":"73f936e.597a5c8","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":4020,"y":1600,"wires":[["46d8969d.9b812","72a888f3.c491f"],[]]},{"id":"72a888f3.c491f","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":4250,"y":1600,"wires":[]},{"id":"d56db3b7.22bf28","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3760,"y":1600,"wires":[["73f936e.597a5c8","f64f4b4c.c4a9f"]]},{"id":"f018506f.b975e8","type":"function","z":"7153aef6.c56e78","name":"Convert Insert SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2800,"y":2120,"wires":[["797acbf.0908fb4","d4835b5.3acaa28"]]},{"id":"797acbf.0908fb4","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":3120,"y":2020,"wires":[]},{"id":"cead2986.c183c","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4010,"y":2060,"wires":[]},{"id":"23647871.282f08","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3760,"y":2120,"wires":[["cead2986.c183c","3e49aa.faf24e56"],[]]},{"id":"3e49aa.faf24e56","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":3990,"y":2120,"wires":[]},{"id":"3b59d597.b095d2","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"Insert Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"Insert Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3500,"y":2120,"wires":[["23647871.282f08","26527c76.92e46c"]]},{"id":"75042c44.320c3c","type":"function","z":"7153aef6.c56e78","name":"Convert Update SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2810,"y":2320,"wires":[["50c27616.c04af","bf11bed8.0f2958"]]},{"id":"50c27616.c04af","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":3120,"y":2220,"wires":[]},{"id":"57fa4c46.6f696c","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3970,"y":2260,"wires":[]},{"id":"589294d9.e44994","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3720,"y":2320,"wires":[["57fa4c46.6f696c","43bc0eeb.6ff948"],[]]},{"id":"1d99d061.84b1f8","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3460,"y":2220,"wires":[]},{"id":"43bc0eeb.6ff948","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":3950,"y":2320,"wires":[]},{"id":"3610989c.a2134","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[Gravity][Atomic]Update Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[Gravity][Atomic]Update Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3460,"y":2320,"wires":[["589294d9.e44994","4be6892c.b8fd48"]]},{"id":"d70df3ee.e10e7","type":"function","z":"7153aef6.c56e78","name":"Convert Delete SendRecordReply Payload","func":"\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload2 = msg.payload\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2810,"y":2520,"wires":[["7802def6.d215c8","8bffd9d5.979488"]]},{"id":"7802def6.d215c8","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":3120,"y":2420,"wires":[]},{"id":"7498b1bd.c79558","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":4010,"y":2460,"wires":[]},{"id":"6a78e61a.367f4","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3760,"y":2520,"wires":[["7498b1bd.c79558","f654b9be.ed7548"],[]]},{"id":"d4c9b002.365a88","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3440,"y":2420,"wires":[]},{"id":"f654b9be.ed7548","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":3990,"y":2520,"wires":[]},{"id":"193e3619.c54b7a","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[Gravity][Atomic]Delete Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[Gravity][Atomic]Delete Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3480,"y":2540,"wires":[["6a78e61a.367f4","7ecc5d0e.374174"]]},{"id":"43179385.98c52c","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":3900,"y":660,"wires":[]},{"id":"72c60f3b.c40a5","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":3960,"y":1180,"wires":[]},{"id":"f64f4b4c.c4a9f","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":4020,"y":1540,"wires":[]},{"id":"26527c76.92e46c","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":3760,"y":2020,"wires":[]},{"id":"4be6892c.b8fd48","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":3740,"y":2260,"wires":[]},{"id":"7ecc5d0e.374174","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":3720,"y":2420,"wires":[]},{"id":"cd65d825.b84ae8","type":"switch","z":"7153aef6.c56e78","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":2360,"y":1260,"wires":[["3eb28ed5.f03fd2"],["3eb28ed5.f03fd2"],["dddf8ef1.c21f98"],["8f3eb139.81bc18"]]},{"id":"b93cd733.bfed68","type":"switch","z":"7153aef6.c56e78","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":2280,"y":2320,"wires":[["f018506f.b975e8"],["f018506f.b975e8"],["75042c44.320c3c"],["b8be81a.d97988"],["b8be81a.d97988"]]},{"id":"88b494de.00eb98","type":"debug","z":"7153aef6.c56e78","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2160,"y":1140,"wires":[]},{"id":"e8593f6c.1a4a5","type":"nats-streaming-subscribe","z":"7153aef6.c56e78","name":"Send Record Product","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"cache1-atomic-sendrecord-0001","start":"all","start_option":"","durable":true,"durable_name":"cache1-atomic-sendrecord-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":1660,"y":1260,"wires":[["97868fc.3ad64f"]]},{"id":"d4835b5.3acaa28","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [dbo].[send_record]                                                                                                                AS send_record,\n        [dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        \n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3140,"y":2100,"wires":[["3b59d597.b095d2"]]},{"id":"bf11bed8.0f2958","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3160,"y":2320,"wires":[["3610989c.a2134"]]},{"id":"8bffd9d5.979488","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":3160,"y":2540,"wires":[["193e3619.c54b7a"]]},{"id":"b8be81a.d97988","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"","x":2600,"y":2440,"wires":[]},{"id":"10105e9f.407401","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":3480,"y":2020,"wires":[]},{"id":"4e97727.b341c0c","type":"nats-streaming-subscribe","z":"8f6ffea1.82b41","name":"SendRecordReplyProduct","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"cache2-atomic-sendreply-0001","start":"all","start_option":"","durable":true,"durable_name":"cache2-atomic-sendreply-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":310,"y":1680,"wires":[["b60598f5.a73898"]]},{"id":"b60598f5.a73898","type":"json","z":"8f6ffea1.82b41","name":"","property":"payload","action":"","pretty":false,"x":590,"y":1680,"wires":[["62839e6a.21c48"]]},{"id":"c27e41a6.f6992","type":"json","z":"8f6ffea1.82b41","name":"","property":"payload","action":"","pretty":false,"x":550,"y":620,"wires":[["236012b4.7d090e","dbe59ca7.302fc8"]]},{"id":"95058e67.281c9","type":"function","z":"8f6ffea1.82b41","name":"Convert Insert SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1530,"y":240,"wires":[["64b03623.e984f8","bafc289.2f01758"]]},{"id":"64b03623.e984f8","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":140,"wires":[]},{"id":"bafc289.2f01758","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [NBPReport].[dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [NBPReport].[dbo].[send_record]                                                                                                                AS send_record,\n        [NBPReport].[dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1840,"y":240,"wires":[["db4ceeca.559e4"]]},{"id":"d267e84d.907a08","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2690,"y":40,"wires":[]},{"id":"3052cb55.16c4d4","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2440,"y":100,"wires":[["d267e84d.907a08","23e4d416.c6d8fc"],[]]},{"id":"23e4d416.c6d8fc","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2670,"y":100,"wires":[]},{"id":"db4ceeca.559e4","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2180,"y":100,"wires":[["3052cb55.16c4d4","b12f1d14.e02be8"]]},{"id":"65473fbd.3e19","type":"function","z":"8f6ffea1.82b41","name":"Convert Update SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1570,"y":620,"wires":[["27f9ecaa.e2103c","df99f082.417b5"]]},{"id":"27f9ecaa.e2103c","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1880,"y":520,"wires":[]},{"id":"df99f082.417b5","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1880,"y":620,"wires":[["5a17896b.c7cf2"]]},{"id":"acea19d.7fe17e8","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2750,"y":560,"wires":[]},{"id":"6c2599b3.06301","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2500,"y":620,"wires":[["acea19d.7fe17e8","e12682c0.b67388"],[]]},{"id":"e12682c0.b67388","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2730,"y":620,"wires":[]},{"id":"5a17896b.c7cf2","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2240,"y":620,"wires":[["6c2599b3.06301","42b2f2d8.abbafc"]]},{"id":"dbef3456.8062","type":"function","z":"8f6ffea1.82b41","name":"Convert Delete SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.payload.send_time = convert_datetime(msg.payload.send_time)\nmsg.payload.expire_time = convert_datetime(msg.payload.expire_time)\nmsg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\nmsg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\nmsg.payload.dr_time = convert_datetime(msg.payload.dr_time)\nmsg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1630,"y":960,"wires":[["3526fddd.36176a","7d4b4ded.526824"]]},{"id":"3526fddd.36176a","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1920,"y":880,"wires":[]},{"id":"7d4b4ded.526824","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1920,"y":960,"wires":[["72a0ce36.4dd768"]]},{"id":"3dc236d8.c2f40a","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2830,"y":900,"wires":[]},{"id":"e1d30a26.9dee78","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2580,"y":960,"wires":[["3dc236d8.c2f40a","394f6396.e4fc0c"],[]]},{"id":"394f6396.e4fc0c","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2810,"y":960,"wires":[]},{"id":"72a0ce36.4dd768","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2320,"y":960,"wires":[["e1d30a26.9dee78","525b6f0c.ff63c8"]]},{"id":"151cea74.df4abe","type":"function","z":"8f6ffea1.82b41","name":"Convert Insert SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1360,"y":1480,"wires":[["f78fb443.ffd378","bce20be9.47987"]]},{"id":"f78fb443.ffd378","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1680,"y":1380,"wires":[]},{"id":"d5c414a5.d203f","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2570,"y":1420,"wires":[]},{"id":"c1105d25.853b1","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2320,"y":1480,"wires":[["d5c414a5.d203f","a8172ddf.2dff88"],[]]},{"id":"a8172ddf.2dff88","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2550,"y":1480,"wires":[]},{"id":"f186087b.0904c","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"Insert Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"Insert Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2060,"y":1480,"wires":[["c1105d25.853b1","b15d0a96.81c2b8"]]},{"id":"3866d170.58cede","type":"function","z":"8f6ffea1.82b41","name":"Convert Update SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":1680,"wires":[["85d358b7.bebf48","41ef2d7b.b8449c"]]},{"id":"85d358b7.bebf48","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1680,"y":1580,"wires":[]},{"id":"a385ee69.837f6","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2530,"y":1620,"wires":[]},{"id":"fb0a30e7.c375b8","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2280,"y":1680,"wires":[["a385ee69.837f6","11524db4.2dd97a"],[]]},{"id":"83a9fb02.0513c8","type":"debug","z":"8f6ffea1.82b41","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2020,"y":1580,"wires":[]},{"id":"11524db4.2dd97a","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2510,"y":1680,"wires":[]},{"id":"34ebbb18.e0f624","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[Gravity][Atomic]Update Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[Gravity][Atomic]Update Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2020,"y":1680,"wires":[["fb0a30e7.c375b8","d91604b3.2699e8"]]},{"id":"39ddee6f.ce2712","type":"function","z":"8f6ffea1.82b41","name":"Convert Delete SendRecordReply Payload","func":"\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload2 = msg.payload\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":1880,"wires":[["a5fc805a.f9bff8","f8b288a6.5c7148"]]},{"id":"a5fc805a.f9bff8","type":"debug","z":"8f6ffea1.82b41","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1680,"y":1780,"wires":[]},{"id":"60875807.ae89a8","type":"debug","z":"8f6ffea1.82b41","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2570,"y":1820,"wires":[]},{"id":"cedd1aef.d2e41","type":"switch","z":"8f6ffea1.82b41","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2320,"y":1880,"wires":[["60875807.ae89a8","2399fd27.b301da"],[]]},{"id":"6a9477b5.c52808","type":"debug","z":"8f6ffea1.82b41","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2000,"y":1780,"wires":[]},{"id":"2399fd27.b301da","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"STAN ACK","x":2550,"y":1880,"wires":[]},{"id":"40cf76fe.b1d48","type":"function","z":"8f6ffea1.82b41","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[Gravity][Atomic]Delete Report DB MsgInfo for Success, SendRecrordReply UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[Gravity][Atomic]Delete Report DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":1900,"wires":[["cedd1aef.d2e41","b4a5b219.1b373"]]},{"id":"b12f1d14.e02be8","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2460,"y":20,"wires":[]},{"id":"42b2f2d8.abbafc","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2520,"y":540,"wires":[]},{"id":"525b6f0c.ff63c8","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2580,"y":900,"wires":[]},{"id":"b15d0a96.81c2b8","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2320,"y":1380,"wires":[]},{"id":"d91604b3.2699e8","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2300,"y":1620,"wires":[]},{"id":"b4a5b219.1b373","type":"redis-out","z":"8f6ffea1.82b41","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2280,"y":1780,"wires":[]},{"id":"236012b4.7d090e","type":"switch","z":"8f6ffea1.82b41","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":920,"y":620,"wires":[["95058e67.281c9"],["95058e67.281c9"],["65473fbd.3e19"],["dbef3456.8062"]]},{"id":"62839e6a.21c48","type":"switch","z":"8f6ffea1.82b41","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":840,"y":1680,"wires":[["151cea74.df4abe"],["151cea74.df4abe"],["3866d170.58cede"],["876b54d8.0ee508"],["876b54d8.0ee508"]]},{"id":"dbe59ca7.302fc8","type":"debug","z":"8f6ffea1.82b41","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":500,"wires":[]},{"id":"f599fcef.5d8c5","type":"nats-streaming-subscribe","z":"8f6ffea1.82b41","name":"Send Record Product","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"cache2-atomic-sendrecord-0001","start":"all","start_option":"","durable":true,"durable_name":"cache2-atomic-sendrecord-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":220,"y":620,"wires":[["c27e41a6.f6992"]]},{"id":"bce20be9.47987","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [dbo].[send_record]                                                                                                                AS send_record,\n        [dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        \n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1700,"y":1460,"wires":[["f186087b.0904c"]]},{"id":"41ef2d7b.b8449c","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1720,"y":1680,"wires":[["34ebbb18.e0f624"]]},{"id":"f8b288a6.5c7148","type":"MSSQL","z":"8f6ffea1.82b41","mssqlCN":"f04213fa.c22b48","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1720,"y":1900,"wires":[["40cf76fe.b1d48"]]},{"id":"876b54d8.0ee508","type":"nats-streaming-acknowledge","z":"8f6ffea1.82b41","name":"","x":1160,"y":1800,"wires":[]},{"id":"c58f0ef9.0fe6","type":"debug","z":"8f6ffea1.82b41","name":"Debug MSSQL Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2040,"y":1380,"wires":[]}]