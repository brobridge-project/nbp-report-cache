[{"id":"614e30cb.432cb8","type":"tab","label":"Report Main","disabled":false,"info":""},{"id":"7153aef6.c56e78","type":"tab","label":"Cache1","disabled":false,"info":""},{"id":"d6fac98e.651838","type":"tab","label":"Report  MsgMO","disabled":false,"info":""},{"id":"f04213fa.c22b48","type":"MSSQL-CN","tdsVersion":"7_4","name":"Cache1 MSSQL","server":"{{{CACHE1_DATABASE_HOST}}}","port":"{{{CACHE1_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{CACHE1_DATABASE_DB}}}","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"35b0806c.4ac0e8","type":"MSSQL-CN","tdsVersion":"7_4","name":"Report MSSQL","server":"{{{REPORT_DATABASE_HOST}}}","port":"{{{REPORT_DATABASE_PORT}}}","encyption":true,"trustServerCertificate":true,"database":"{{{REPORT_DATABASE_DB}}}","useUTC":false,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5","parseJSON":false,"enableArithAbort":true},{"id":"81898769.b5aff8","type":"nats-streaming-server","server":"gravity-report-nats","port":"4222","cluster":"external-stan"},{"id":"9610aff8.a70458","type":"redis-config","name":"redis-cluster:6379","options":"redis://redis-cluster:6379","cluster":false,"optionsType":"str"},{"id":"a2506feb.4395c8","type":"switch","z":"d6fac98e.651838","name":"Check Payload Event","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":1160,"y":3940,"wires":[["9085d068.426c2"],["9085d068.426c2"],["b4c111a4.07306"],["7de22074.356508"],["b3784723.885fa8"]]},{"id":"57e99674.8ec748","type":"nats-streaming-subscribe","z":"d6fac98e.651838","d":true,"name":"Send Record","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"report-atomic-0002","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0002","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":150,"y":1820,"wires":[["f7e65feb.01f7b8"]]},{"id":"f7e65feb.01f7b8","type":"json","z":"d6fac98e.651838","name":"","property":"payload","action":"","pretty":false,"x":410,"y":1820,"wires":[["ddbbee5a.867a6","2b3c06a9.e67eaa"]]},{"id":"6b225fce.a8ff58","type":"nats-streaming-subscribe","z":"d6fac98e.651838","d":true,"name":"Send record reply","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"report-atomic-0004","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0003","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":270,"y":3940,"wires":[["5e6a14a5.bef4fc"]]},{"id":"5e6a14a5.bef4fc","type":"json","z":"d6fac98e.651838","name":"","property":"payload","action":"","pretty":false,"x":590,"y":3940,"wires":[["a2506feb.4395c8","c90d8eb5.1ff2a"]]},{"id":"9085d068.426c2","type":"function","z":"d6fac98e.651838","name":"Convert Insert MsgMo Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_strip_datetime_as_string(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + month + day + hour + minute + second\n  return NewSendTime\n} \n\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\n\nfunction truncate_string_length(value, length, allow_null=true) {\n\n if (typeof value === 'string' || value instanceof String) {\n\n  if (value == null) { \n      if (allow_null) { return null }\n      else { return \"\" }\n   }\n \n  return value.substring(0, length)\n  \n } else {\n  if (value == null) { \n      if (allow_null) { return null }\n      else { return \"\" }\n   }\n }\n}\n\nmsg.payload = msg.payload.payload\n\nmsg.payload.UID = convert_uuid(msg.payload.uid)\nmsg.payload.SerialNo = msg.payload.UID\nmsg.payload.ReceiveTime = convert_strip_datetime_as_string(msg.payload.update_time)\nmsg.payload.MID = truncate_string_length(msg.payload.code,10)\nmsg.payload.DestNo = truncate_string_length(msg.payload.customer_phone,20)\nmsg.payload.MsgData = truncate_string_length(msg.payload.reply_content,256)\n\nmsg.send_record_reply_uid = msg.payload.UID\n\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1810,"y":3640,"wires":[["e618abac.46e9c8","a3f2a4f3.aae808"]]},{"id":"a3f2a4f3.aae808","type":"debug","z":"d6fac98e.651838","name":"Debug Report MsgMo Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2100,"y":3480,"wires":[]},{"id":"e618abac.46e9c8","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"Cache MsgMo MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [dbo].[MsgMo](UID,SerialNo,ReceiveTime,MID,DestNo,MsgData) values(@UID,@SerialNo,@ReceiveTime,@MID,@DestNo,@MsgData)","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNo","type":"UniqueIdentifier","valueType":"msg","value":"payload.SerialNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ReceiveTime","type":"VarChar(?)","valueType":"msg","value":"payload.ReceiveTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MID","type":"VarChar(?)","valueType":"msg","value":"payload.MID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestNo","type":"VarChar(?)","valueType":"msg","value":"payload.DestNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2230,"y":3640,"wires":[["8c26387d.6f11d8","fb883624.f29298","d645b68e.b51f18"]]},{"id":"21916cd4.521c94","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3110,"y":3540,"wires":[]},{"id":"55cd3660.1ae038","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2880,"y":3640,"wires":[["e74b793f.9a6f08","21916cd4.521c94"],[]]},{"id":"8c26387d.6f11d8","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2580,"y":3520,"wires":[]},{"id":"e74b793f.9a6f08","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":3150,"y":3620,"wires":[]},{"id":"fb883624.f29298","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update DB MsgMo for Success, UID:\" + msg.send_record_reply_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB MsgMo table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2600,"y":3640,"wires":[["55cd3660.1ae038"]]},{"id":"b4c111a4.07306","type":"function","z":"d6fac98e.651838","name":"Convert Update MsgMo Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nfunction truncate_string_length(value, length, allow_null=true) {\n\n if (typeof value === 'string' || value instanceof String) {\n\n  if (value == null) { \n      if (allow_null) { return null }\n      else { return \"\" }\n   }\n \n  return value.substring(0, length)\n  \n } else {\n  if (value == null) { \n      if (allow_null) { return null }\n      else { return \"\" }\n   }\n }\n}\n\nfunction convert_strip_datetime_as_string(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + month + day + hour + minute + second\n  return NewSendTime\n} \n\n\n\nmsg.payload = msg.payload.payload\n\nmsg.payload.UID = convert_uuid(msg.payload.uid)\nmsg.payload.SerialNo = msg.payload.UID\nmsg.payload.ReceiveTime = convert_strip_datetime_as_string(msg.payload.update_time)\nmsg.payload.MID = truncate_string_length(msg.payload.code,10)\nmsg.payload.DestNo = truncate_string_length(msg.payload.customer_phone,20)\nmsg.payload.MsgData = truncate_string_length(msg.payload.reply_content,256)\n\nmsg.send_record_reply_uid = msg.payload.UID\n\n\nreturn msg\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1860,"y":3940,"wires":[["96299829.f2c6d8","8b40363b.4b6128"]]},{"id":"96299829.f2c6d8","type":"debug","z":"d6fac98e.651838","name":"Debug Report MsgMo Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2080,"y":3820,"wires":[]},{"id":"dddda066.de3118","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3090,"y":3880,"wires":[]},{"id":"7cc63f23.b6a2b","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2840,"y":3940,"wires":[["8e0afd46.6dbf8","dddda066.de3118"],[]]},{"id":"782c033c.69f924","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2540,"y":3840,"wires":[]},{"id":"8e0afd46.6dbf8","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":3070,"y":3940,"wires":[]},{"id":"78d40ef0.af4388","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update DB MsgMo for Success, UID:\" + msg.send_record_reply_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB MsgMo table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2600,"y":3940,"wires":[["7cc63f23.b6a2b"]]},{"id":"7de22074.356508","type":"function","z":"d6fac98e.651838","name":"Convert Delete  Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\n\nmsg.payload = msg.payload.payload\n\nmsg.payload.UID = convert_uuid(msg.payload.uid)\nmsg.send_record_reply_uid = msg.payload.UID\n\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1890,"y":4400,"wires":[["a38b50a7.06cb18","c998bb98.31a968"]]},{"id":"a38b50a7.06cb18","type":"debug","z":"d6fac98e.651838","name":"Debug ","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2190,"y":4340,"wires":[]},{"id":"c998bb98.31a968","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"Cache MsgMo","outField":"payload","returnType":0,"throwErrors":"0","query":"DELETE from [dbo].[MsgMo] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2300,"y":4400,"wires":[["158cf5bb.2b84f2","7260ca54.1c478c","b7c06bcf.30488"]]},{"id":"e32a644f.88d978","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3130,"y":4340,"wires":[]},{"id":"528f087b.dd9ed8","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2820,"y":4400,"wires":[["5d309080.97acf","e32a644f.88d978"],[]]},{"id":"158cf5bb.2b84f2","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2580,"y":4340,"wires":[]},{"id":"5d309080.97acf","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":3130,"y":4400,"wires":[]},{"id":"7260ca54.1c478c","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete DB MsgMo for Success, UID:\" + msg.send_record_reply_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete DB MsgMo table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2580,"y":4400,"wires":[["528f087b.dd9ed8"]]},{"id":"8b40363b.4b6128","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"Cache  MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"UPDATE [dbo].[MsgMo] SET SerialNo=@SerialNo, ReceiveTime=@ReceiveTime, MID=@MID, DestNo=@DestNo, MsgData=@MsgData WHERE UID=@UID","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNo","type":"VarChar(?)","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ReceiveTime","type":"VarChar(?)","valueType":"msg","value":"payload.ReceiveTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MID","type":"VarChar(?)","valueType":"msg","value":"payload.MID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestNo","type":"VarChar(?)","valueType":"msg","value":"payload.DestNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2200,"y":3940,"wires":[["78d40ef0.af4388","782c033c.69f924","4d408237.10978c"]]},{"id":"b3784723.885fa8","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":1390,"y":4400,"wires":[]},{"id":"ddbbee5a.867a6","type":"switch","z":"d6fac98e.651838","name":"Check Payload Event","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordProductCreate","vt":"str"},{"t":"eq","v":"SendRecordProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordProductDelete","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":740,"y":1820,"wires":[["6ae42ebc.7ad6c"],["6ae42ebc.7ad6c"],["53e84286.cf4834"],["3703beee.13e732"],["1452a052.e198e8"]]},{"id":"2b3c06a9.e67eaa","type":"debug","z":"d6fac98e.651838","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":500,"y":1700,"wires":[]},{"id":"c90d8eb5.1ff2a","type":"debug","z":"d6fac98e.651838","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":780,"y":3860,"wires":[]},{"id":"3703beee.13e732","type":"function","z":"d6fac98e.651838","name":"Convert Delete Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.send_record_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1150,"y":2940,"wires":[["f6985476.a0a708","29e6d3d2.67af94"]]},{"id":"f6985476.a0a708","type":"debug","z":"d6fac98e.651838","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1460,"y":2840,"wires":[]},{"id":"29e6d3d2.67af94","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"SI_SinoPacBank and MsgInfo","outField":"payload","returnType":0,"throwErrors":"0","query":"\ndelete from [dbo].[SI_SinoPacBank] where uid=@uid\n\ndelete from [dbo].[MsgInfo] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1690,"y":2940,"wires":[["667200e3.c6ac6","8debfa1f.9216f8"]]},{"id":"f1c3aee7.6d6098","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2420,"y":2940,"wires":[["2ce0c317.e4a5a4"],[]]},{"id":"667200e3.c6ac6","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1980,"y":2840,"wires":[]},{"id":"8debfa1f.9216f8","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB DB-MsgInfo and SI_SinoPacBank for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB DB-MsgInfo and SI_SinoPacBank table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2060,"y":2940,"wires":[["f1c3aee7.6d6098","3ff28535.59d9fa","f4185c1f.e63a9"]]},{"id":"264a298b.708006","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":4070,"y":1280,"wires":[]},{"id":"f005b31b.0eb2b","type":"switch","z":"d6fac98e.651838","name":"","property":"done","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1130,"y":1180,"wires":[["5f9e08b5.5ab76"]]},{"id":"6ae42ebc.7ad6c","type":"function","z":"d6fac98e.651838","name":"","func":"\nif ( global.get(\"MsgInfo_Done\") == 1 && global.get(\"SI_SinoPacBank_Done\") == 1 ) {\n    msg.done = 1\n} \n\nelse {\n    msg.done = 0\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"// 部署節點後，此處的程式碼將運行一次。 \n\n\nglobal.set(\"MsgInfo_Done\", 1)\nglobal.set(\"SI_SinoPacBank_Done\",1)","finalize":"","libs":[],"x":910,"y":1180,"wires":[["f005b31b.0eb2b"]]},{"id":"90a1a83c.811dc","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"35b0806c.4ac0e8","name":"Query","outField":"payload2","returnType":"1","throwErrors":"0","query":"select send_record.uid              as UID,\n       send_record.req_uid          as GroupID,\n       send.create_user             as UserName,\n       ''                           as SourceType,\n       send.req_object_id           as ObjectID,\n       send_record.uid              as SerialNo,\n       send_record.customer_phone   as DestNo,\n       send_record.req_uid          as DestName,\n       send.req_department          as DestCategory,\n       send.msg_type                as MsgType,\n       send_record.content          as MsgData,\n       ''                           as OrderID,\n       ''                           as MID,\n       send_record.content          as MsgData,\n       send_record.actual_send_time as SubmitTime,\n       send_record.send_time        as OrderTime,\n       send_record.expire_time      as ExpireTime,\n       send_record.resp_code        as StatusFlag,\n       ''                           as SubmitFlag,\n       ''                           as Filler,\n       send_record.dr_time          as StatusTime,\n       send.req_batch_id            as BatchCode\nfrom   send as send,\n       send_record as send_record\nwhere  send_record.uid = @uid\n       and send_record.send_uid = send.uid ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1830,"y":1500,"wires":[["959d512b.2669c","d6797b7.a125a08","655831c3.08e27"]]},{"id":"5f9e08b5.5ab76","type":"function","z":"d6fac98e.651838","name":"Convert Insert Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.send_record_table_uid = msg.payload.uid\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1460,"y":1180,"wires":[["67b17676.168ba","d1d5cc74.1e9768","2a05629f.f39196"]]},{"id":"67b17676.168ba","type":"debug","z":"d6fac98e.651838","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1720,"y":940,"wires":[]},{"id":"1f0deec1.823129","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3100,"y":1180,"wires":[["eb0a1093.b86f4"],[]]},{"id":"c25bec6f.6e26f","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2060,"y":940,"wires":[]},{"id":"2c239bc.b1def64","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB DB-MsgInfo Success, UID:\" +   msg.result1_uuid\n\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB DB-MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2820,"y":1180,"wires":[["1f0deec1.823129","6c443f04.468a88","fea35dd1.6db93"]]},{"id":"d1d5cc74.1e9768","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"35b0806c.4ac0e8","name":"Query","outField":"payload","returnType":"1","throwErrors":"0","query":"select [dbo].[send_record].uid                                              as UID,\n       [dbo].[send_record].serial_number                                    as SerialNum,\n       [dbo].[send_record].req_uid                                          as GUID,\n       [dbo].[send_record].customer_phone                                   as MPhoneNum,\n       [dbo].[send_record].content                                          as MsgData,\n       [dbo].send.priority                                                  as Priority,\n       [dbo].[send_record].send_time                                        as BookingTime,\n       Datediff(SECOND, [send_record].send_time, [send_record].expire_time) as ExpireTime,\n       [dbo].send.req_department                                            as DepID,\n       [dbo].send.msg_type                                                  as MsgType,\n       [dbo].send.memo                                                      as Memo,\n       [dbo].[send_record].customer_id                                      as SenderID,\n       [dbo].send.req_bu                                                    as Bu,\n       [dbo].send.req_company                                               as Company,\n       [dbo].send.req_channel                                               as Channel,\n       [dbo].[send_record].customer_reference                               as Reference\nfrom   send_record,\n       send\nwhere  send_record.uid = @uid\n       and send_record.send_uid = send.uid ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1830,"y":1180,"wires":[["c25bec6f.6e26f","39a429b1.d04dd6","8ccd8294.43d1b"]]},{"id":"39a429b1.d04dd6","type":"debug","z":"d6fac98e.651838","name":"Debug Select result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2070,"y":1020,"wires":[]},{"id":"2e271fd1.9f1f2","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"DB-MsgInfo","outField":"payload","returnType":"1","throwErrors":"0","query":"INSERT INTO [dbo].[SI_SinoPacBank]\n            (UID,\n             SerialNum,\n             GUID,\n             MPhoneNum,\n             MsgData,\n             Priority,\n             BookingTime,\n             ExpireTime,\n             DepID,\n             MsgType,\n             Memo,\n             SenderID,\n             Bu,\n             Company,\n             Channel,\n             Reference)\nVALUES     (@UID,\n            @SerialNum,\n            @GUID,\n            @MPhoneNum,\n            @MsgData,\n            @Priority,\n            @BookingTime,\n            @ExpireTime,\n            @DepID,\n            @MsgType,\n            @Memo,\n            @SenderID,\n            @Bu,\n            @Company,\n            @Channel,\n            @Reference) ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNum","type":"Int","valueType":"msg","value":"payload.SerialNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"GUID","type":"VarChar(?)","valueType":"msg","value":"payload.GUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MPhoneNum","type":"VarChar(?)","valueType":"msg","value":"payload.MPhoneNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Memo","type":"VarChar(?)","valueType":"msg","value":"payload.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SenderID","type":"VarChar(?)","valueType":"msg","value":"payload.SenderID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Bu","type":"VarChar(?)","valueType":"msg","value":"payload.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Company","type":"VarChar(?)","valueType":"msg","value":"payload.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Channel","type":"VarChar(?)","valueType":"msg","value":"payload.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Reference","type":"VarChar(?)","valueType":"msg","value":"payload.Reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Priority","type":"int","valueType":"msg","value":"payload.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"BookingTime","type":"DateTime","valueType":"msg","value":"payload.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ExpireTime","type":"Int","valueType":"msg","value":"payload.ExpireTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DepID","type":"VarChar(?)","valueType":"msg","value":"payload.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgType","type":"VarChar(?)","valueType":"msg","value":"payload.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2570,"y":1180,"wires":[["2c239bc.b1def64"]]},{"id":"8ccd8294.43d1b","type":"function","z":"d6fac98e.651838","name":"Get Result1","func":"\ntry {\n  msg.payload = msg.payload.recordset[0]\n  msg.result1_uuid = msg.payload.UID\n  msg.result1_length_is_zero=0\n}\n\ncatch (e) {\n    msg.result1_length_is_zero=1\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2150,"y":1180,"wires":[["50f69be8.24f1ec","583e9967.9a9408"]]},{"id":"1962f4ed.3846eb","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3240,"y":1660,"wires":[["f9ae5de8.f72818"],[]]},{"id":"959d512b.2669c","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2040,"y":1360,"wires":[]},{"id":"e1c4e0a1.d4bcd","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB MsgInfo Success, UID:\" + msg.result2_uuid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2960,"y":1660,"wires":[["1962f4ed.3846eb","26fe461c.3d99ba","37f5c29d.1fecde"]]},{"id":"d6797b7.a125a08","type":"debug","z":"d6fac98e.651838","name":"Debug Select result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2.recordset","targetType":"msg","statusVal":"","statusType":"auto","x":2030,"y":1420,"wires":[]},{"id":"dd8561a4.8fc078","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"MsgInfo","outField":"payload","returnType":"0","throwErrors":"0","query":"INSERT INTO [dbo].[MsgInfo](UID,GroupID,UserName,SourceType,ObjectID,SerialNo,DestNo,DestName,DestCategory,MsgType,MsgData,DelegateTime,SubmitTime,OrderID,MID,OrderTime,ExpireTime,StatusFlag,SubmitFlag,StatusTime,BatchCode,Filler) VALUES (@UID, @GroupID, @UserName,@SourceType,@ObjectID,@SerialNo,@DestNo,@DestName,@DestCategory,@MsgType,@MsgData,@DelegateTime,@SubmitTime,@OrderID,@MID,@OrderTime,@ExpireTime,@StatusFlag,@SubmitFlag,@StatusTime,@BatchCode,@Filler)","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload2.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"GroupID","type":"VarChar(?)","valueType":"msg","value":"payload2.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"UserName","type":"VarChar(?)","valueType":"msg","value":"payload2.UserName","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SourceType","type":"VarChar(?)","valueType":"msg","value":"payload2.SourceType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ObjectID","type":"VarChar(?)","valueType":"msg","value":"payload2.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNo","type":"VarChar(?)","valueType":"msg","value":"payload2.SerialNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestNo","type":"VarChar(?)","valueType":"msg","value":"payload2.DestNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestName","type":"VarChar(?)","valueType":"msg","value":"payload2.DestName","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestCategory","type":"VarChar(?)","valueType":"msg","value":"payload2.DestCategory","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgType","type":"VarChar(?)","valueType":"msg","value":"payload2.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload2.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DelegateTime","type":"VarChar(?)","valueType":"msg","value":"payload2.DelegateTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SubmitTime","type":"VarChar(?)","valueType":"msg","value":"payload2.SubmitTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"OrderID","type":"VarChar(?)","valueType":"msg","value":"payload2.OrderID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MID","type":"VarChar(?)","valueType":"msg","value":"payload2.MID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"OrderTime","type":"VarChar(?)","valueType":"msg","value":"payload2.OrderTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ExpireTime","type":"VarChar(?)","valueType":"msg","value":"payload2.ExpireTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"StatusFlag","type":"VarChar(?)","valueType":"msg","value":"payload2.StatusFlag","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SubmitFlag","type":"VarChar(?)","valueType":"msg","value":"payload2.SubmitFlag","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"StatusTime","type":"VarChar(?)","valueType":"msg","value":"payload2.StatusTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"BatchCode","type":"VarChar(?)","valueType":"msg","value":"payload2.BatchCode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Filler","type":"VarChar(?)","valueType":"msg","value":"payload2.Filter","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2700,"y":1660,"wires":[["e1c4e0a1.d4bcd"]]},{"id":"655831c3.08e27","type":"function","z":"d6fac98e.651838","name":"Get Result2","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_strip_datetime_as_string(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + month + day + hour + minute + second\n  return NewSendTime\n} \n\n\ntry {\n  msg.payload2 = msg.payload2.recordset[0]\n  msg.result2_uuid = msg.payload2.UID\n  msg.payload2.OrderTime = convert_strip_datetime_as_string(msg.payload2.OrderTime)\n  msg.payload2.ExpireTime = convert_strip_datetime_as_string(msg.payload2.ExpireTime)\n  msg.payload2.StatusTime = convert_strip_datetime_as_string(msg.payload2.StatusTime)\n  \n  msg.result2_length_is_zero=0\n}\n\ncatch (e) {\n    msg.result2_length_is_zero=1\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2030,"y":1660,"wires":[["77350f67.8b69e","62aead8b.ac180c"]]},{"id":"a7dfbbc6.7a9028","type":"switch","z":"d6fac98e.651838","name":"","property":"done","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":3850,"y":1320,"wires":[["264a298b.708006"]]},{"id":"991a5271.038c68","type":"function","z":"d6fac98e.651838","name":"","func":"\nif ( global.get(\"MsgInfo_Done\") == 1 && global.get(\"SI_SinoPacBank_Done\") == 1 ) {\n    msg.done = 1\n} \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3690,"y":1320,"wires":[["a7dfbbc6.7a9028"]]},{"id":"eb0a1093.b86f4","type":"function","z":"d6fac98e.651838","name":"","func":"\nglobal.set(\"MsgInfo_Done\",1)\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3450,"y":1180,"wires":[["991a5271.038c68"]]},{"id":"f9ae5de8.f72818","type":"function","z":"d6fac98e.651838","name":"","func":"\nglobal.get(\"SI_SinoPacBank_Done\",1)\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3470,"y":1660,"wires":[["991a5271.038c68"]]},{"id":"50f69be8.24f1ec","type":"debug","z":"d6fac98e.651838","name":"Debug Select result1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload ","targetType":"msg","statusVal":"","statusType":"auto","x":2360,"y":1100,"wires":[]},{"id":"2a05629f.f39196","type":"delay","z":"d6fac98e.651838","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1640,"y":1500,"wires":[["90a1a83c.811dc"]]},{"id":"77350f67.8b69e","type":"switch","z":"d6fac98e.651838","name":"","property":"result2_length_is_zero","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2350,"y":1660,"wires":[["dd8561a4.8fc078","dd94b5a9.c6ed98"],["18eb6a3b.178d4e"]]},{"id":"18eb6a3b.178d4e","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"ACK","x":2510,"y":1760,"wires":[]},{"id":"583e9967.9a9408","type":"switch","z":"d6fac98e.651838","name":"","property":"result1_length_is_zero","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2330,"y":1180,"wires":[["2e271fd1.9f1f2"],["c8c2065.d73fbf8"]]},{"id":"c8c2065.d73fbf8","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"ACK","x":2590,"y":1260,"wires":[]},{"id":"62aead8b.ac180c","type":"debug","z":"d6fac98e.651838","name":"Debug Select result2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2.recordset","targetType":"msg","statusVal":"","statusType":"auto","x":2260,"y":1580,"wires":[]},{"id":"dd94b5a9.c6ed98","type":"debug","z":"d6fac98e.651838","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":2520,"y":1520,"wires":[]},{"id":"6c443f04.468a88","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3090,"y":1080,"wires":[]},{"id":"26fe461c.3d99ba","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3270,"y":1560,"wires":[]},{"id":"9e90e9b5.ec2158","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":4150,"y":2340,"wires":[]},{"id":"b1965875.477718","type":"switch","z":"d6fac98e.651838","name":"","property":"done","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1330,"y":2100,"wires":[["e9e96bcb.5e9db"]]},{"id":"53e84286.cf4834","type":"function","z":"d6fac98e.651838","name":"","func":"\nif ( global.get(\"MsgInfo_Done\") == 1 && global.get(\"SI_SinoPacBank_Done\") == 1 ) {\n    msg.done = 1\n} \n\nelse {\n    msg.done = 0\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"// 部署節點後，此處的程式碼將運行一次。 \n\n\nglobal.set(\"MsgInfo_Done\", 1)\nglobal.set(\"SI_SinoPacBank_Done\",1)","finalize":"","libs":[],"x":1130,"y":2100,"wires":[["b1965875.477718"]]},{"id":"80709ef9.3e50d","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"35b0806c.4ac0e8","name":"Query","outField":"payload2","returnType":"1","throwErrors":"0","query":"select [dbo].[send_record].uid as UID, 'SINOPACC' as GroupID, send.create_user as UserName, '' as SourceType, send.req_object_id as ObjectID, send_record.uid as SerialNo, send_record.customer_phone as DestNo, send_record.req_group_id as DestName, send.req_department as DestCategory, 0 as MsgType, send_record.content as MsgData, '' as OrderID, '' as MID, send_record.content as MsgData, send_record.actual_send_time as SubmitTime, send_record.send_time as OrderTime, send_record.expire_time as ExpireTime, send_record.resp_code as StatusFlag, '' as SubmitFlag, '' as Filler, send_record.dr_time as StatusTime, send.req_batch_id as BatchCode from send , send_record  where send_record.uid=@uid and send_record.send_uid = send.uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2030,"y":2440,"wires":[["1526ea1e.e551ce","4309a071.bc1a","3760c938.a0291e"]]},{"id":"e9e96bcb.5e9db","type":"function","z":"d6fac98e.651838","name":"Convert Update Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.send_record_table_uid = msg.payload.uid\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1570,"y":2100,"wires":[["f772ac2c.18a608","146af954.1912af","cbcda390.0737e8"]]},{"id":"f772ac2c.18a608","type":"debug","z":"d6fac98e.651838","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":1880,"wires":[]},{"id":"f3bb358f.d651f8","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3320,"y":2100,"wires":[["9fa7c0a6.72a8f"],[]]},{"id":"e43bdfe1.5b3438","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2220,"y":1880,"wires":[]},{"id":"a983e704.b80d18","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB DB-MsgInfo Success, UID:\" +   msg.result1_uuid\n\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB DB-MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3040,"y":2100,"wires":[["f3bb358f.d651f8","707363c4.e9ecec","ea2dd672.857a48"]]},{"id":"146af954.1912af","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"35b0806c.4ac0e8","name":"Query","outField":"payload","returnType":"1","throwErrors":"0","query":"select [dbo].[send_record].uid as UID, [dbo].[send_record].serial_number as SerialNum, [dbo].[send_record].req_group_id as GUID, [dbo].[send_record].customer_phone as MPhoneNum, [dbo].[send_record].content as MsgData, [dbo].send.priority as Priority, [dbo].[send_record].send_time as BookingTime, DATEDIFF(SECOND,[send_record].send_time,[send_record].expire_time) as ExpireTime, [dbo].send.req_department as DepID, [dbo].send.msg_type as MsgType, [dbo].send.memo as Memo , [dbo].[send_record].customer_id as SenderID, [dbo].send.req_bu as Bu, [dbo].send.req_company as Company, [dbo].send.req_channel as Channel, [dbo].[send_record].customer_reference as Reference from send_record, send where send_record.uid=@uid and send_record.send_uid = send.uid\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1930,"y":2100,"wires":[["e43bdfe1.5b3438","e75b242c.1da0b8","30ab4f66.777fa"]]},{"id":"e75b242c.1da0b8","type":"debug","z":"d6fac98e.651838","name":"Debug Select result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2230,"y":1940,"wires":[]},{"id":"e208747.d3e1788","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"DB-MsgInfo","outField":"payload","returnType":"1","throwErrors":"0","query":"UPDATE [dbo].[SI_SinoPacBank] SET UID=@UID, SerialNum=@SerialNum, GUID=@GUID, MPhoneNum=@MPhoneNum, MsgData=@MsgData, Priority=@Priority, BookingTime=@BookingTime, ExpireTime=@ExpireTime, DepID=@DepID, MsgType=@MsgType, Memo=@Memo ,SenderID=@SenderID ,Bu=@Bu ,Company=@Company, Channel=@Channel, Reference=@Reference WHERE UID=@UID","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNum","type":"Int","valueType":"msg","value":"payload.SerialNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"GUID","type":"VarChar(?)","valueType":"msg","value":"payload.GUID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MPhoneNum","type":"VarChar(?)","valueType":"msg","value":"payload.MPhoneNum","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Memo","type":"VarChar(?)","valueType":"msg","value":"payload.Memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SenderID","type":"VarChar(?)","valueType":"msg","value":"payload.SenderID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Bu","type":"VarChar(?)","valueType":"msg","value":"payload.Bu","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Company","type":"VarChar(?)","valueType":"msg","value":"payload.Company","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Channel","type":"VarChar(?)","valueType":"msg","value":"payload.Channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Reference","type":"VarChar(?)","valueType":"msg","value":"payload.Reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Priority","type":"int","valueType":"msg","value":"payload.Priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"BookingTime","type":"DateTime","valueType":"msg","value":"payload.BookingTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ExpireTime","type":"Int","valueType":"msg","value":"payload.ExpireTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DepID","type":"VarChar(?)","valueType":"msg","value":"payload.DepID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgType","type":"VarChar(?)","valueType":"msg","value":"payload.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2790,"y":2100,"wires":[["a983e704.b80d18"]]},{"id":"30ab4f66.777fa","type":"function","z":"d6fac98e.651838","name":"Get Result1","func":"\ntry {\n  msg.payload = msg.payload.recordset[0]\n  msg.result1_uuid = msg.payload.UID\n  msg.result1_length_is_zero=0\n}\n\ncatch (e) {\n    msg.result1_length_is_zero=1\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2370,"y":2100,"wires":[["7080a0ad.bd4d78","97519d74.9761a"]]},{"id":"7b9ddc8b.7aa09c","type":"switch","z":"d6fac98e.651838","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3420,"y":2500,"wires":[["43afbb34.330a9c"],[]]},{"id":"1526ea1e.e551ce","type":"debug","z":"d6fac98e.651838","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2240,"y":2300,"wires":[]},{"id":"a27938a7.cdc388","type":"function","z":"d6fac98e.651838","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB MsgInfo Success, UID:\" + msg.result2_uuid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Cache DB MsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3140,"y":2500,"wires":[["7b9ddc8b.7aa09c","d62c3750.acdf38","908d57b8.12296"]]},{"id":"4309a071.bc1a","type":"debug","z":"d6fac98e.651838","name":"Debug Select result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2.recordset","targetType":"msg","statusVal":"","statusType":"auto","x":2230,"y":2360,"wires":[]},{"id":"528a96f9.c96828","type":"MSSQL","z":"d6fac98e.651838","mssqlCN":"f04213fa.c22b48","name":"MsgInfo","outField":"payload","returnType":"0","throwErrors":"0","query":"UPDATE [dbo].[MsgInfo] SET GroupID=@GroupID,UserName=@UserName,SourceType=@SourceType,ObjectID=@ObjectID,SerialNo=@SerialNo,DestNo=@DestNo,DestName=@DestName,DestCategory=@DestCategory,MsgType=@MsgType,MsgData=@MsgData,DelegateTime=@DelegateTime,SubmitTime=@SubmitTime,OrderID=@OrderID,MID=@MID,OrderTime=@OrderTime,ExpireTime=@ExpireTime,StatusFlag=@StatusFlag,SubmitFlag=@SubmitFlag,StatusTime=@StatusTime,BatchCode=@BatchCode,Filler=@Filler WHERE\nUID=@UID","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"UID","type":"UniqueIdentifier","valueType":"msg","value":"payload2.UID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"GroupID","type":"VarChar(?)","valueType":"msg","value":"payload2.GroupID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"UserName","type":"VarChar(?)","valueType":"msg","value":"payload2.UserName","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SourceType","type":"VarChar(?)","valueType":"msg","value":"payload2.SourceType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ObjectID","type":"VarChar(?)","valueType":"msg","value":"payload2.ObjectID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SerialNo","type":"VarChar(?)","valueType":"msg","value":"payload2.SerialNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestNo","type":"VarChar(?)","valueType":"msg","value":"payload2.DestNo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestName","type":"VarChar(?)","valueType":"msg","value":"payload2.DestName","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DestCategory","type":"VarChar(?)","valueType":"msg","value":"payload2.DestCategory","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgType","type":"VarChar(?)","valueType":"msg","value":"payload2.MsgType","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MsgData","type":"VarChar(?)","valueType":"msg","value":"payload2.MsgData","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"DelegateTime","type":"VarChar(?)","valueType":"msg","value":"payload2.DelegateTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SubmitTime","type":"VarChar(?)","valueType":"msg","value":"payload2.SubmitTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"OrderID","type":"VarChar(?)","valueType":"msg","value":"payload2.OrderID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"MID","type":"VarChar(?)","valueType":"msg","value":"payload2.MID","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"OrderTime","type":"VarChar(?)","valueType":"msg","value":"payload2.OrderTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"ExpireTime","type":"VarChar(?)","valueType":"msg","value":"payload2.ExpireTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"StatusFlag","type":"VarChar(?)","valueType":"msg","value":"payload2.StatusFlag","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"SubmitFlag","type":"VarChar(?)","valueType":"msg","value":"payload2.SubmitFlag","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"StatusTime","type":"VarChar(?)","valueType":"msg","value":"payload2.StatusTime","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"BatchCode","type":"VarChar(?)","valueType":"msg","value":"payload2.BatchCode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"Filler","type":"VarChar(?)","valueType":"msg","value":"payload2.Filter","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":2900,"y":2500,"wires":[["a27938a7.cdc388"]]},{"id":"3760c938.a0291e","type":"function","z":"d6fac98e.651838","name":"Get Result2","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_strip_datetime_as_string(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + month + day + hour + minute + second\n  return NewSendTime\n} \n\n\ntry {\n  msg.payload2 = msg.payload2.recordset[0]\n  msg.result2_uuid = msg.payload2.UID\n  msg.payload2.OrderTime = convert_strip_datetime_as_string(msg.payload2.OrderTime)\n  msg.payload2.ExpireTime = convert_strip_datetime_as_string(msg.payload2.ExpireTime)\n  msg.payload2.StatusTime = convert_strip_datetime_as_string(msg.payload2.StatusTime)\n  \n  msg.result2_length_is_zero=0\n}\n\ncatch (e) {\n    msg.result2_length_is_zero=1\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2210,"y":2600,"wires":[["a6195391.5017a8","7631439.07d87bc"]]},{"id":"1a047389.40cbbc","type":"switch","z":"d6fac98e.651838","name":"","property":"done","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":3950,"y":2340,"wires":[["9e90e9b5.ec2158"]]},{"id":"6d24f21d.9f530c","type":"function","z":"d6fac98e.651838","name":"","func":"\nif ( global.get(\"MsgInfo_Done\") == 1 && global.get(\"SI_SinoPacBank_Done\") == 1 ) {\n    msg.done = 1\n} \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3750,"y":2340,"wires":[["1a047389.40cbbc"]]},{"id":"9fa7c0a6.72a8f","type":"function","z":"d6fac98e.651838","name":"","func":"\nglobal.set(\"MsgInfo_Done\",1)\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3670,"y":2100,"wires":[["6d24f21d.9f530c"]]},{"id":"43afbb34.330a9c","type":"function","z":"d6fac98e.651838","name":"","func":"\nglobal.get(\"SI_SinoPacBank_Done\",1)\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3650,"y":2500,"wires":[["6d24f21d.9f530c"]]},{"id":"7080a0ad.bd4d78","type":"debug","z":"d6fac98e.651838","name":"Debug Select result1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload ","targetType":"msg","statusVal":"","statusType":"auto","x":2580,"y":1940,"wires":[]},{"id":"cbcda390.0737e8","type":"delay","z":"d6fac98e.651838","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1840,"y":2440,"wires":[["80709ef9.3e50d"]]},{"id":"a6195391.5017a8","type":"switch","z":"d6fac98e.651838","name":"","property":"result2_length_is_zero","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2570,"y":2600,"wires":[["528a96f9.c96828","5bd1807d.acfa08"],["846a1167.ed0898"]]},{"id":"846a1167.ed0898","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"ACK","x":2810,"y":2700,"wires":[]},{"id":"97519d74.9761a","type":"switch","z":"d6fac98e.651838","name":"","property":"result1_length_is_zero","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2550,"y":2100,"wires":[["e208747.d3e1788"],["76d69a06.8039a4"]]},{"id":"76d69a06.8039a4","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"ACK","x":2730,"y":2200,"wires":[]},{"id":"7631439.07d87bc","type":"debug","z":"d6fac98e.651838","name":"Debug Select result2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2.recordset","targetType":"msg","statusVal":"","statusType":"auto","x":2460,"y":2520,"wires":[]},{"id":"5bd1807d.acfa08","type":"debug","z":"d6fac98e.651838","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":2900,"y":2600,"wires":[]},{"id":"707363c4.e9ecec","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3310,"y":2000,"wires":[]},{"id":"d62c3750.acdf38","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":3450,"y":2400,"wires":[]},{"id":"9353cd95.70a01","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":3090,"y":2940,"wires":[]},{"id":"3ff28535.59d9fa","type":"debug","z":"d6fac98e.651838","name":"Log Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2310,"y":2840,"wires":[]},{"id":"1452a052.e198e8","type":"nats-streaming-acknowledge","z":"d6fac98e.651838","name":"STAN ACK","x":590,"y":2160,"wires":[]},{"id":"2ce0c317.e4a5a4","type":"switch","z":"d6fac98e.651838","name":"","property":"have_error","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2730,"y":2920,"wires":[["9353cd95.70a01"]]},{"id":"fea35dd1.6db93","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":3100,"y":960,"wires":[]},{"id":"37f5c29d.1fecde","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":3300,"y":1480,"wires":[]},{"id":"ea2dd672.857a48","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":3320,"y":1920,"wires":[]},{"id":"908d57b8.12296","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":3480,"y":2320,"wires":[]},{"id":"f4185c1f.e63a9","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":2320,"y":2760,"wires":[]},{"id":"d645b68e.b51f18","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":2560,"y":3440,"wires":[]},{"id":"4d408237.10978c","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":2540,"y":3780,"wires":[]},{"id":"b7c06bcf.30488","type":"redis-out","z":"d6fac98e.651838","server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_report_cache","obj":true,"x":2580,"y":4260,"wires":[]},{"id":"c9498d87.732028","type":"switch","z":"614e30cb.432cb8","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendProductInitialize","vt":"str"},{"t":"eq","v":"SendProductCreate","vt":"str"},{"t":"eq","v":"SendProductUpdate","vt":"str"},{"t":"eq","v":"SendProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":800,"y":600,"wires":[["382c2b24.ba7354"],["382c2b24.ba7354"],["8839250d.2ab64"],["34ba69bc.70caee"]]},{"id":"99212330.723e98","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"SendRecordReplyProduct","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"atomic-0001","start":"all","start_option":"","durable":true,"durable_name":"atomic-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":290,"y":2840,"wires":[["a0774be.57d4a38"]]},{"id":"a0774be.57d4a38","type":"json","z":"614e30cb.432cb8","name":"","property":"payload","action":"","pretty":false,"x":570,"y":2840,"wires":[["2fe2c718.3ce1d"]]},{"id":"4853b82f.2c1008","type":"json","z":"614e30cb.432cb8","name":"","property":"payload","action":"","pretty":false,"x":530,"y":1780,"wires":[["a32e65ea.f8ba98","e03ce2c1.02ca1"]]},{"id":"28f2adbe.cc268a","type":"json","z":"614e30cb.432cb8","name":"","property":"payload","action":"","pretty":false,"x":470,"y":600,"wires":[["c9498d87.732028","30477230.5e0686"]]},{"id":"382c2b24.ba7354","type":"function","z":"614e30cb.432cb8","name":"Kernel Insert Send Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.create_user = convert_uuid(msg.payload.create_user)\nmsg.payload.update_user = convert_uuid(msg.payload.update_user)\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.completed_time = convert_datetime(msg.payload.completed_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.send_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1340,"y":380,"wires":[["af8a7297.e975b","bb4ac397.5aaad8"]]},{"id":"af8a7297.e975b","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1570,"y":300,"wires":[]},{"id":"bb4ac397.5aaad8","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [NBPReport].[dbo].[send] \n            (uid, \n             event_code, \n             way_name, \n             send_from,\n             send_date,\n             template_code, \n             template_max_length, \n             send_mode, \n             limit_mode, \n             mod_reply, \n             status, \n             priority, \n             msg_type, \n             req_channel, \n             req_batch_id, \n             memo, \n             create_time, \n             create_user, \n             update_time, \n             update_user, \n             completed_time, \n             canceled_time, \n             update_expired_time) \nVALUES     (@uid, \n            @event_code, \n            @way_name, \n            @send_date,\n            @template_code, \n            @template_max_length, \n            @send_mode, \n            @limit_mode, \n            @mod_reply, \n            @status, \n            @priority, \n            @msg_type, \n            @req_channel, \n            @req_batch_id, \n            @memo, \n            @create_time, \n            @create_user, \n            @update_time, \n            @update_user, \n            @completed_time, \n            @canceled_time, \n            @update_expired_time) ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_from","type":"Int","valueType":"msg","value":"payload.send_from","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_date","type":"DateTime2","valueType":"msg","value":"payload.send_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_code","type":"VarChar(?)","valueType":"msg","value":"payload.template_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_max_length","type":"Int","valueType":"msg","value":"payload.template_max_length","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_mode","type":"Char","valueType":"msg","value":"payload.send_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"limit_mode","type":"TinyInt","valueType":"msg","value":"payload.limit_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"mod_reply","type":"TinyInt","valueType":"msg","value":"payload.mod_reply","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"priority","type":"Int","valueType":"msg","value":"payload.priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_type","type":"VarChar(?)","valueType":"msg","value":"payload.msg_type","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"payload.req_channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_batch_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"NVarChar(?)","valueType":"msg","value":"payload.memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_user","type":"VarChar(?)","valueType":"msg","value":"payload.create_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_user","type":"VarChar(?)","valueType":"msg","value":"payload.update_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"completed_time","type":"DateTime2","valueType":"msg","value":"payload.completed_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1740,"y":380,"wires":[["7375daf7.11a44c","935005db.4841b8"]]},{"id":"e01bb264.a1f7d","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2510,"y":320,"wires":[]},{"id":"2fb47436.63e984","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2260,"y":380,"wires":[["e01bb264.a1f7d","1fa126a1.b37081"],[]]},{"id":"7375daf7.11a44c","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":300,"wires":[]},{"id":"1fa126a1.b37081","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2490,"y":380,"wires":[]},{"id":"30477230.5e0686","type":"debug","z":"614e30cb.432cb8","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":620,"y":500,"wires":[]},{"id":"935005db.4841b8","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB send table for Success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB send table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":380,"wires":[["2fb47436.63e984","9e572e83.23ccd8"]]},{"id":"8b334374.be5d8","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"UPDATE [NBPReport].[dbo].[send] \nSET    event_code = @event_code, \n       way_name = @way_name, \n       send_date = @ send_date\n       send_from = @send_from, \n       template_code = @template_code, \n       template_max_length = @template_max_length, \n       send_mode = @send_mode, \n       limit_mode = @limit_mode, \n       mod_reply = @mod_reply, \n       status = @status, \n       priority = @priority, \n       msg_type = @msg_type, \n       req_channel = @req_channel, \n       req_batch_id = @req_batch_id, \n       memo = @memo, \n       create_time = @create_time, \n       create_user = @create_user, \n       update_time = @update_time, \n       update_user = @update_user, \n       completed_time = @completed_time, \n       canceled_time = @canceled_time, \n       update_expired_time = @update_expired_time \nWHERE  uid = @uid ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_from","type":"Int","valueType":"msg","value":"payload.send_from","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_date","type":"DateTime2","valueType":"msg","value":"payload.send_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_code","type":"VarChar(?)","valueType":"msg","value":"payload.template_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_max_length","type":"Int","valueType":"msg","value":"payload.template_max_length","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_mode","type":"Char","valueType":"msg","value":"payload.send_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"limit_mode","type":"TinyInt","valueType":"msg","value":"payload.limit_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"mod_reply","type":"TinyInt","valueType":"msg","value":"payload.mod_reply","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"priority","type":"Int","valueType":"msg","value":"payload.priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_type","type":"VarChar(?)","valueType":"msg","value":"payload.msg_type","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"payload.req_channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_batch_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"NVarChar(?)","valueType":"msg","value":"payload.memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_user","type":"VarChar(?)","valueType":"msg","value":"payload.create_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_user","type":"VarChar(?)","valueType":"msg","value":"payload.update_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"completed_time","type":"DateTime2","valueType":"msg","value":"payload.completed_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1660,"y":600,"wires":[["ff00d1eb.847e8","729b5bbe.df38c4"]]},{"id":"8839250d.2ab64","type":"function","z":"614e30cb.432cb8","name":"Kernel Send Update Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.create_user = convert_uuid(msg.payload.create_user)\nmsg.payload.update_user = convert_uuid(msg.payload.update_user)\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.completed_time = convert_datetime(msg.payload.completed_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.send_table_uid = msg.payload.uid\nmsg.payload2 = msg.payload\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":600,"wires":[["8b334374.be5d8","3a0e6f05.fe24d8"]]},{"id":"3a0e6f05.fe24d8","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1590,"y":520,"wires":[]},{"id":"23c09adf.b355be","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2410,"y":520,"wires":[]},{"id":"15907c72.719eac","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2160,"y":600,"wires":[["23c09adf.b355be","a6ca4fa4.8906c"],[]]},{"id":"729b5bbe.df38c4","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1860,"y":520,"wires":[]},{"id":"a6ca4fa4.8906c","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2410,"y":600,"wires":[]},{"id":"ff00d1eb.847e8","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send table success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[[GRAVITY][ATOMIC] Update Report DB send table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1900,"y":600,"wires":[["15907c72.719eac","ec3285e2.cc0ef8"]]},{"id":"26220f87.19d888","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\ndelete from [NBPReport].[dbo].[send] WHERE uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1600,"y":860,"wires":[["a6e39a12.5ced","8aa7e2fd.fc5228"]]},{"id":"34ba69bc.70caee","type":"function","z":"614e30cb.432cb8","name":"Kernel Send Delete Payload","func":"function convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.send_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1300,"y":860,"wires":[["26220f87.19d888","39cdd2e7.04789e"]]},{"id":"39cdd2e7.04789e","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1550,"y":800,"wires":[]},{"id":"48ee5636.2a1988","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2370,"y":800,"wires":[]},{"id":"c4419a6a.3c4428","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2120,"y":860,"wires":[["48ee5636.2a1988","b2ce4cce.f94d78"],[]]},{"id":"8aa7e2fd.fc5228","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":800,"wires":[]},{"id":"b2ce4cce.f94d78","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2370,"y":860,"wires":[]},{"id":"a6e39a12.5ced","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send table Success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1860,"y":860,"wires":[["c4419a6a.3c4428","b317c289.8875d8"]]},{"id":"416a0cbf.2caedc","type":"function","z":"614e30cb.432cb8","name":"Convert Insert SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1510,"y":1400,"wires":[["45a60f20.434178","1df7eb99.7a1914"]]},{"id":"45a60f20.434178","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1820,"y":1300,"wires":[]},{"id":"1df7eb99.7a1914","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nINSERT INTO [NBPReport].[dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [NBPReport].[dbo].[send_record]                                                                                                                AS send_record,\n        [NBPReport].[dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1820,"y":1400,"wires":[["15bf858d.895d2a"]]},{"id":"894f33e7.c272c8","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2670,"y":1200,"wires":[]},{"id":"9ae22d19.db31a","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2420,"y":1260,"wires":[["894f33e7.c272c8","9840cca0.f5e53"],[]]},{"id":"9840cca0.f5e53","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2650,"y":1260,"wires":[]},{"id":"15bf858d.895d2a","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB SI_SinoPacBankMsgInfo table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2160,"y":1260,"wires":[["9ae22d19.db31a","96687b7b.110868"]]},{"id":"5e733dbf.2ab56c","type":"function","z":"614e30cb.432cb8","name":"Convert Update SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":1780,"wires":[["1428463.3e0b63a","32053f8c.c797a"]]},{"id":"1428463.3e0b63a","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1860,"y":1680,"wires":[]},{"id":"32053f8c.c797a","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"BEGIN\n\nBEGIN TRANSACTION;\n\nDECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [NBPReport].[dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n\n\nCOMMIT;\n\nEND","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1860,"y":1780,"wires":[["250f7221.5d6be6"]]},{"id":"720bc634.ca06f","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2730,"y":1720,"wires":[]},{"id":"6400e7f.be1b098","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2480,"y":1780,"wires":[["720bc634.ca06f","c0e5a995.394a68"],[]]},{"id":"c0e5a995.394a68","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2710,"y":1780,"wires":[]},{"id":"250f7221.5d6be6","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2220,"y":1780,"wires":[["6400e7f.be1b098","3fa1c4eb.479a34"]]},{"id":"f9a1e260.adf7c","type":"function","z":"614e30cb.432cb8","name":"Convert Delete SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.payload.send_time = convert_datetime(msg.payload.send_time)\nmsg.payload.expire_time = convert_datetime(msg.payload.expire_time)\nmsg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\nmsg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\nmsg.payload.dr_time = convert_datetime(msg.payload.dr_time)\nmsg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1610,"y":2120,"wires":[["9a20ee81.864b2","c5a4e075.9f2bc"]]},{"id":"9a20ee81.864b2","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1900,"y":2040,"wires":[]},{"id":"c5a4e075.9f2bc","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1900,"y":2120,"wires":[["2a85354b.94b5d2"]]},{"id":"976be76.546b998","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2810,"y":2060,"wires":[]},{"id":"1e29f584.412b4a","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2560,"y":2120,"wires":[["976be76.546b998","f13e12bb.5f506"],[]]},{"id":"f13e12bb.5f506","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2790,"y":2120,"wires":[]},{"id":"2a85354b.94b5d2","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2300,"y":2120,"wires":[["1e29f584.412b4a","e5fd1e7d.7fbc9"]]},{"id":"14ef2c68.517584","type":"function","z":"614e30cb.432cb8","name":"Convert Insert SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1340,"y":2640,"wires":[["44b9ef63.a5a7e","c9b26a70.cd479"]]},{"id":"44b9ef63.a5a7e","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2540,"wires":[]},{"id":"c9b26a70.cd479","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [NBPReport].[dbo].[send_record_reply] \n            (uid, \n             send_record_uid, \n             customer_id, \n             customer_phone, \n             customer_reference, \n             tx_date, \n             tx_time, \n             event_code, \n             return_code, \n             create_time, \n             update_time, \n             reply_content, \n             reply_time, \n             status, \n             gateway_id, \n             code) \nVALUES     (@uid, \n            @send_record_uid, \n            @customer_id, \n            @customer_phone, \n            @customer_reference, \n            @tx_date, \n            @tx_time, \n            @event_code, \n            @return_code, \n            @create_time, \n            @update_time, \n            @reply_content, \n            @reply_time, \n            @status, \n            @gateway_id, \n            @code) \n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_record_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_date","type":"VarChar(?)","valueType":"msg","value":"payload.tx_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_time","type":"VarChar(?)","valueType":"msg","value":"payload.tx_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_content","type":"VarChar(?)","valueType":"msg","value":"payload.reply_content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_time","type":"DateTime2","valueType":"msg","value":"payload.reply_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"TinyInt","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"code","type":"VarChar(?)","valueType":"msg","value":"payload.code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1680,"y":2640,"wires":[["75611b29.e6039c","18634ca8.e72dbb"]]},{"id":"d44b5151.e51ce8","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2550,"y":2580,"wires":[]},{"id":"b04af07f.77b0b","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2300,"y":2640,"wires":[["d44b5151.e51ce8","47dfd36.66d3bac"],[]]},{"id":"75611b29.e6039c","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2020,"y":2540,"wires":[]},{"id":"47dfd36.66d3bac","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2530,"y":2640,"wires":[]},{"id":"18634ca8.e72dbb","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"Insert Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"Insert Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":2640,"wires":[["b04af07f.77b0b","9121192.861f468"]]},{"id":"98e36337.465e1","type":"function","z":"614e30cb.432cb8","name":"Convert Update SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":2840,"wires":[["dd90e772.d28e7","619a1815.b3405"]]},{"id":"dd90e772.d28e7","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2740,"wires":[]},{"id":"619a1815.b3405","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"UPDATE [NBPReport].[dbo].[send_record_reply] \nSET    send_record_uid = @send_record_uid, \n       customer_id = @customer_id, \n       customer_phone = @customer_phone, \n       customer_reference = @customer_reference, \n       tx_date = @tx_date, \n       tx_time = @tx_time, \n       event_code = @event_code, \n       return_code = @return_code, \n       create_time = @create_time, \n       update_time = @update_time, \n       reply_content = @reply_content, \n       reply_time = @reply_time, \n       status = @status, \n       gateway_id = @gateway_id, \n       code = @code \nWHERE  uid = @uid\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_record_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_date","type":"VarChar(?)","valueType":"msg","value":"payload.tx_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_time","type":"VarChar(?)","valueType":"msg","value":"payload.tx_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_content","type":"VarChar(?)","valueType":"msg","value":"payload.reply_content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_time","type":"DateTime2","valueType":"msg","value":"payload.reply_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"TinyInt","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"code","type":"VarChar(?)","valueType":"msg","value":"payload.code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1680,"y":2840,"wires":[["b00b68c4.8b94c","d76401fa.b070e"]]},{"id":"598dba1a.47e914","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2510,"y":2780,"wires":[]},{"id":"d22bfa52.32c5f","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2260,"y":2840,"wires":[["598dba1a.47e914","94b1a069.8f83a"],[]]},{"id":"b00b68c4.8b94c","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":2000,"y":2740,"wires":[]},{"id":"94b1a069.8f83a","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2490,"y":2840,"wires":[]},{"id":"d76401fa.b070e","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2000,"y":2840,"wires":[["d22bfa52.32c5f","1af123ed.d5d27c"]]},{"id":"52ce9a54.50cee4","type":"function","z":"614e30cb.432cb8","name":"Convert Delete SendRecordReply Payload","func":"\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload2 = msg.payload\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":3040,"wires":[["546c86f6.9aa6f","ad26be13.cc34c8"]]},{"id":"546c86f6.9aa6f","type":"debug","z":"614e30cb.432cb8","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2940,"wires":[]},{"id":"ad26be13.cc34c8","type":"MSSQL","z":"614e30cb.432cb8","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DELETE from [NBPReport].[dbo].[send_record_reply] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1680,"y":3040,"wires":[["da5464f0.d784a8","a24f1b0f.0c6cf"]]},{"id":"5a8a0539.7df364","type":"debug","z":"614e30cb.432cb8","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2550,"y":2980,"wires":[]},{"id":"b00645d9.3e8db8","type":"switch","z":"614e30cb.432cb8","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2300,"y":3040,"wires":[["5a8a0539.7df364","5cc0630.96b3a9c"],[]]},{"id":"da5464f0.d784a8","type":"debug","z":"614e30cb.432cb8","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1980,"y":2940,"wires":[]},{"id":"5cc0630.96b3a9c","type":"nats-streaming-acknowledge","z":"614e30cb.432cb8","name":"STAN ACK","x":2530,"y":3040,"wires":[]},{"id":"a24f1b0f.0c6cf","type":"function","z":"614e30cb.432cb8","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":3040,"wires":[["b00645d9.3e8db8","c9dcf942.4870c8"]]},{"id":"846251a1.8b7838","type":"debug","z":"614e30cb.432cb8","name":"Redis Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":510,"y":3400,"wires":[]},{"id":"586c2d4f.708bb4","type":"redis-in","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"subscribe","name":"","topic":"gravity_kernel_report","obj":true,"timeout":"3","x":320,"y":3400,"wires":[["846251a1.8b7838"]]},{"id":"9e572e83.23ccd8","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2260,"y":300,"wires":[]},{"id":"ec3285e2.cc0ef8","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2140,"y":520,"wires":[]},{"id":"b317c289.8875d8","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2120,"y":800,"wires":[]},{"id":"96687b7b.110868","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2440,"y":1180,"wires":[]},{"id":"3fa1c4eb.479a34","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2500,"y":1700,"wires":[]},{"id":"e5fd1e7d.7fbc9","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2560,"y":2060,"wires":[]},{"id":"9121192.861f468","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2300,"y":2540,"wires":[]},{"id":"1af123ed.d5d27c","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2280,"y":2780,"wires":[]},{"id":"c9dcf942.4870c8","type":"redis-out","z":"614e30cb.432cb8","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2260,"y":2940,"wires":[]},{"id":"a32e65ea.f8ba98","type":"switch","z":"614e30cb.432cb8","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":900,"y":1780,"wires":[["416a0cbf.2caedc"],["416a0cbf.2caedc"],["5e733dbf.2ab56c"],["f9a1e260.adf7c"]]},{"id":"2fe2c718.3ce1d","type":"switch","z":"614e30cb.432cb8","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":820,"y":2840,"wires":[["14ef2c68.517584"],["14ef2c68.517584"],["98e36337.465e1"],["52ce9a54.50cee4"]]},{"id":"e03ce2c1.02ca1","type":"debug","z":"614e30cb.432cb8","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":1660,"wires":[]},{"id":"48f11524.1999dc","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"Send Record","server":"81898769.b5aff8","channel":"rowData.source.SendProduct","clientID":"report-atomic-0002","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0002","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"30","x":190,"y":600,"wires":[["28f2adbe.cc268a"]]},{"id":"1f953ccc.2f2c8b","type":"nats-streaming-subscribe","z":"614e30cb.432cb8","name":"Send Record Product","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"report-atomic-0003","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0003","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"1","x":200,"y":1780,"wires":[["4853b82f.2c1008"]]},{"id":"3e5f7134.6f0d6e","type":"switch","z":"7153aef6.c56e78","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendProductInitialize","vt":"str"},{"t":"eq","v":"SendProductCreate","vt":"str"},{"t":"eq","v":"SendProductUpdate","vt":"str"},{"t":"eq","v":"SendProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":740,"y":380,"wires":[["da24c345.15dcf8"],["da24c345.15dcf8"],["14fd0f8e.0e7f78"],["1de1aa2d.c9209e"]]},{"id":"86c04999.0c9be","type":"nats-streaming-subscribe","z":"7153aef6.c56e78","name":"SendRecordReplyProduct","server":"81898769.b5aff8","channel":"rowData.source.SendRecordReplyProduct","clientID":"cache-atomic-0003","start":"all","start_option":"","durable":true,"durable_name":"atomic-0001","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"30","x":230,"y":2620,"wires":[["20ff7e95.168e6a"]]},{"id":"20ff7e95.168e6a","type":"json","z":"7153aef6.c56e78","name":"","property":"payload","action":"","pretty":false,"x":510,"y":2620,"wires":[["ba35f7d4.57351"]]},{"id":"90c9145b.bcb18","type":"json","z":"7153aef6.c56e78","name":"","property":"payload","action":"","pretty":false,"x":470,"y":1560,"wires":[["ebfd1d89.e5ab8","670fb898.5cd938"]]},{"id":"c4ac64dd.4141e","type":"json","z":"7153aef6.c56e78","name":"","property":"payload","action":"","pretty":false,"x":410,"y":380,"wires":[["3e5f7134.6f0d6e","a4c435b4.238ad"]]},{"id":"da24c345.15dcf8","type":"function","z":"7153aef6.c56e78","name":"Kernel Insert Send Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.create_user = convert_uuid(msg.payload.create_user)\nmsg.payload.update_user = convert_uuid(msg.payload.update_user)\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.completed_time = convert_datetime(msg.payload.completed_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.send_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":160,"wires":[["65a6a345.e47f74","ae319c4b.90edf8"]]},{"id":"65a6a345.e47f74","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1510,"y":80,"wires":[]},{"id":"ae319c4b.90edf8","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [NBPReport].[dbo].[send] \n            (uid, \n             event_code, \n             way_name, \n             send_from,\n             send_date,\n             template_code, \n             template_max_length, \n             send_mode, \n             limit_mode, \n             mod_reply, \n             status, \n             priority, \n             msg_type, \n             req_channel, \n             req_batch_id, \n             memo, \n             create_time, \n             create_user, \n             update_time, \n             update_user, \n             completed_time, \n             canceled_time, \n             update_expired_time) \nVALUES     (@uid, \n            @event_code, \n            @way_name, \n            @send_date,\n            @template_code, \n            @template_max_length, \n            @send_mode, \n            @limit_mode, \n            @mod_reply, \n            @status, \n            @priority, \n            @msg_type, \n            @req_channel, \n            @req_batch_id, \n            @memo, \n            @create_time, \n            @create_user, \n            @update_time, \n            @update_user, \n            @completed_time, \n            @canceled_time, \n            @update_expired_time) ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_from","type":"Int","valueType":"msg","value":"payload.send_from","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_date","type":"DateTime2","valueType":"msg","value":"payload.send_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_code","type":"VarChar(?)","valueType":"msg","value":"payload.template_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_max_length","type":"Int","valueType":"msg","value":"payload.template_max_length","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_mode","type":"Char","valueType":"msg","value":"payload.send_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"limit_mode","type":"TinyInt","valueType":"msg","value":"payload.limit_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"mod_reply","type":"TinyInt","valueType":"msg","value":"payload.mod_reply","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"priority","type":"Int","valueType":"msg","value":"payload.priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_type","type":"VarChar(?)","valueType":"msg","value":"payload.msg_type","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"payload.req_channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_batch_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"NVarChar(?)","valueType":"msg","value":"payload.memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_user","type":"VarChar(?)","valueType":"msg","value":"payload.create_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_user","type":"VarChar(?)","valueType":"msg","value":"payload.update_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"completed_time","type":"DateTime2","valueType":"msg","value":"payload.completed_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1680,"y":160,"wires":[["b52fa4ed.d836d","3e13321d.e47796"]]},{"id":"eacbdf51.6afcb","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2450,"y":100,"wires":[]},{"id":"55bf9290.0af02c","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2200,"y":160,"wires":[["eacbdf51.6afcb","661a3e01.7880c8"],[]]},{"id":"b52fa4ed.d836d","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1780,"y":80,"wires":[]},{"id":"661a3e01.7880c8","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2430,"y":160,"wires":[]},{"id":"a4c435b4.238ad","type":"debug","z":"7153aef6.c56e78","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":560,"y":280,"wires":[]},{"id":"3e13321d.e47796","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB send table for Success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Report DB send table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1980,"y":160,"wires":[["55bf9290.0af02c","af3436c.734a5c8"]]},{"id":"1cfd68dd.ef610f","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"UPDATE [NBPReport].[dbo].[send] \nSET    event_code = @event_code, \n       way_name = @way_name, \n       send_date = @ send_date\n       send_from = @send_from, \n       template_code = @template_code, \n       template_max_length = @template_max_length, \n       send_mode = @send_mode, \n       limit_mode = @limit_mode, \n       mod_reply = @mod_reply, \n       status = @status, \n       priority = @priority, \n       msg_type = @msg_type, \n       req_channel = @req_channel, \n       req_batch_id = @req_batch_id, \n       memo = @memo, \n       create_time = @create_time, \n       create_user = @create_user, \n       update_time = @update_time, \n       update_user = @update_user, \n       completed_time = @completed_time, \n       canceled_time = @canceled_time, \n       update_expired_time = @update_expired_time \nWHERE  uid = @uid ","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_from","type":"Int","valueType":"msg","value":"payload.send_from","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_date","type":"DateTime2","valueType":"msg","value":"payload.send_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_code","type":"VarChar(?)","valueType":"msg","value":"payload.template_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"template_max_length","type":"Int","valueType":"msg","value":"payload.template_max_length","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_mode","type":"Char","valueType":"msg","value":"payload.send_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"limit_mode","type":"TinyInt","valueType":"msg","value":"payload.limit_mode","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"mod_reply","type":"TinyInt","valueType":"msg","value":"payload.mod_reply","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"priority","type":"Int","valueType":"msg","value":"payload.priority","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_type","type":"VarChar(?)","valueType":"msg","value":"payload.msg_type","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_channel","type":"VarChar(?)","valueType":"msg","value":"payload.req_channel","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_batch_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_batch_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"memo","type":"NVarChar(?)","valueType":"msg","value":"payload.memo","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_user","type":"VarChar(?)","valueType":"msg","value":"payload.create_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_user","type":"VarChar(?)","valueType":"msg","value":"payload.update_user","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"completed_time","type":"DateTime2","valueType":"msg","value":"payload.completed_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1600,"y":380,"wires":[["61aa7406.99691c","f3e3b7c7.aadc18"]]},{"id":"14fd0f8e.0e7f78","type":"function","z":"7153aef6.c56e78","name":"Kernel Send Update Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.create_user = convert_uuid(msg.payload.create_user)\nmsg.payload.update_user = convert_uuid(msg.payload.update_user)\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.completed_time = convert_datetime(msg.payload.completed_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.send_table_uid = msg.payload.uid\nmsg.payload2 = msg.payload\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":380,"wires":[["1cfd68dd.ef610f","9f0f74f1.fad9e"]]},{"id":"9f0f74f1.fad9e","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1530,"y":300,"wires":[]},{"id":"fa0ecfc6.115308","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2350,"y":300,"wires":[]},{"id":"532ea058.fa75e8","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2100,"y":380,"wires":[["fa0ecfc6.115308","81545448.7fa2b8"],[]]},{"id":"f3e3b7c7.aadc18","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1800,"y":300,"wires":[]},{"id":"81545448.7fa2b8","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2350,"y":380,"wires":[]},{"id":"61aa7406.99691c","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send table success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[[GRAVITY][ATOMIC] Update Report DB send table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1840,"y":380,"wires":[["532ea058.fa75e8","7531b7ef.6da068"]]},{"id":"7a975d01.2e90b4","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report Send Table MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\ndelete from [NBPReport].[dbo].[send] WHERE uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1540,"y":640,"wires":[["e4c7e717.988858","8f7a025b.1a4a68"]]},{"id":"1de1aa2d.c9209e","type":"function","z":"7153aef6.c56e78","name":"Kernel Send Delete Payload","func":"function convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.send_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1240,"y":640,"wires":[["7a975d01.2e90b4","22be5fb5.1ec428"]]},{"id":"22be5fb5.1ec428","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1490,"y":580,"wires":[]},{"id":"946c0c9d.94ad4","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2310,"y":580,"wires":[]},{"id":"9c975689.22cd28","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2060,"y":640,"wires":[["946c0c9d.94ad4","2f68754a.ad5dea"],[]]},{"id":"8f7a025b.1a4a68","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1780,"y":580,"wires":[]},{"id":"2f68754a.ad5dea","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2310,"y":640,"wires":[]},{"id":"e4c7e717.988858","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send table Success, UID:\" + msg.send_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1800,"y":640,"wires":[["9c975689.22cd28","5545c2c1.36a0dc"]]},{"id":"f2161214.868e68","type":"function","z":"7153aef6.c56e78","name":"Convert Insert SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1450,"y":1180,"wires":[["8213f034.5e61f","846bf59a.140d8"]]},{"id":"8213f034.5e61f","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1760,"y":1080,"wires":[]},{"id":"a02b87a1.efadd","type":"function","z":"7153aef6.c56e78","name":"Convert Update SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\n// msg.payload.send_time = convert_datetime(msg.payload.send_time)\n// msg.payload.expire_time = convert_datetime(msg.payload.expire_time)\n// msg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\n// msg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\n// msg.payload.create_time = convert_datetime(msg.payload.create_time)\n// msg.payload.update_time = convert_datetime(msg.payload.update_time)\n// msg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\n// msg.payload.dr_time = convert_datetime(msg.payload.dr_time)\n// msg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\n// msg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1490,"y":1560,"wires":[["eb2a2de2.7f7688","420cec48.99a11c"]]},{"id":"eb2a2de2.7f7688","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1800,"y":1460,"wires":[]},{"id":"66a87ca8.7a2294","type":"function","z":"7153aef6.c56e78","name":"Convert Delete SendRecord Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload2 = msg.payload\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_uid= convert_uuid(msg.payload.send_uid)\n\nmsg.payload.send_time = convert_datetime(msg.payload.send_time)\nmsg.payload.expire_time = convert_datetime(msg.payload.expire_time)\nmsg.payload.actual_send_time = convert_datetime(msg.payload.actual_send_time)\nmsg.payload.finish_time = convert_datetime(msg.payload.finish_time)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.deliver_time = convert_datetime(msg.payload.deliver_time)\n\nmsg.payload.dr_time = convert_datetime(msg.payload.dr_time)\nmsg.payload.canceled_time = convert_datetime(msg.payload.canceled_time)\nmsg.payload.update_expired_time = convert_datetime(msg.payload.update_expired_time)\n\nmsg.send_record_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":1900,"wires":[["c488b784.72361","7218eff9.09b208"]]},{"id":"c488b784.72361","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":1820,"wires":[]},{"id":"7218eff9.09b208","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"delete from [NBPReport].[dbo].[send_record] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1840,"y":1900,"wires":[["c5df42f1.54f288"]]},{"id":"eee788dd.f0556","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2750,"y":1840,"wires":[]},{"id":"a04f0110.8a46c8","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2500,"y":1900,"wires":[["eee788dd.f0556","d0e0bb.4a93d748"],[]]},{"id":"d0e0bb.4a93d748","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2730,"y":1900,"wires":[]},{"id":"c5df42f1.54f288","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record for Success, UID:\" + msg.send_record_table_uid\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2240,"y":1900,"wires":[["a04f0110.8a46c8","3d213895.ed5098"]]},{"id":"546f56f1.65b2b","type":"function","z":"7153aef6.c56e78","name":"Convert Insert SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":2420,"wires":[["a4e0c738.e659c8","c6452579.a917e"]]},{"id":"a4e0c738.e659c8","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1600,"y":2320,"wires":[]},{"id":"c6452579.a917e","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"INSERT INTO [NBPReport].[dbo].[send_record_reply] \n            (uid, \n             send_record_uid, \n             customer_id, \n             customer_phone, \n             customer_reference, \n             tx_date, \n             tx_time, \n             event_code, \n             return_code, \n             create_time, \n             update_time, \n             reply_content, \n             reply_time, \n             status, \n             gateway_id, \n             code) \nVALUES     (@uid, \n            @send_record_uid, \n            @customer_id, \n            @customer_phone, \n            @customer_reference, \n            @tx_date, \n            @tx_time, \n            @event_code, \n            @return_code, \n            @create_time, \n            @update_time, \n            @reply_content, \n            @reply_time, \n            @status, \n            @gateway_id, \n            @code) \n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_record_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_date","type":"VarChar(?)","valueType":"msg","value":"payload.tx_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_time","type":"VarChar(?)","valueType":"msg","value":"payload.tx_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_content","type":"VarChar(?)","valueType":"msg","value":"payload.reply_content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_time","type":"DateTime2","valueType":"msg","value":"payload.reply_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"TinyInt","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"code","type":"VarChar(?)","valueType":"msg","value":"payload.code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1620,"y":2420,"wires":[["40293b57.8c9194","6e72dae6.927c8c"]]},{"id":"6f42d06e.0f88c","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2490,"y":2360,"wires":[]},{"id":"e862e66c.4c9448","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2240,"y":2420,"wires":[["6f42d06e.0f88c","d98a421.ce68dc"],[]]},{"id":"40293b57.8c9194","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1960,"y":2320,"wires":[]},{"id":"d98a421.ce68dc","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2470,"y":2420,"wires":[]},{"id":"6e72dae6.927c8c","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"Insert Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"Insert Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1980,"y":2420,"wires":[["e862e66c.4c9448","2bded10a.0a2636"]]},{"id":"2f72f315.8f9ef4","type":"function","z":"7153aef6.c56e78","name":"Convert Update SendRecordReply Payload","func":"Number.prototype.zeroPad = Number.prototype.zeroPad || \n     function(base){\n       var nr = this, len = (String(base).length - String(nr).length)+1;\n       return len > 0? new Array(len).join('0')+nr : nr;\n};\n\n\nfunction convert_datetime(value) {\n    \n  if (value == null) { return null }\n    \n  t1 = new Date(value)\n  year = t1.getFullYear().zeroPad(1000).toString()\n  month = (t1.getMonth() + 1).zeroPad(10).toString()\n  day = t1.getDate().zeroPad(10).toString()\n  hour = t1.getHours().zeroPad(10).toString()\n  minute = t1.getMinutes().zeroPad(10).toString()\n  second = t1.getSeconds().zeroPad(10).toString()\n  NewSendTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute + \":\" + second\n  return NewSendTime\n} \n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\n\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload.send_record_uid= convert_uuid(msg.payload.send_record_uid)\n\nmsg.payload.create_time = convert_datetime(msg.payload.create_time)\nmsg.payload.update_time = convert_datetime(msg.payload.update_time)\nmsg.payload.reply_time = convert_datetime(msg.payload.reply_time)\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nmsg.payload2 = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":2620,"wires":[["df8ae627.51aa5","79f08c11.97c054"]]},{"id":"df8ae627.51aa5","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1600,"y":2520,"wires":[]},{"id":"79f08c11.97c054","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"UPDATE [NBPReport].[dbo].[send_record_reply] \nSET    send_record_uid = @send_record_uid, \n       customer_id = @customer_id, \n       customer_phone = @customer_phone, \n       customer_reference = @customer_reference, \n       tx_date = @tx_date, \n       tx_time = @tx_time, \n       event_code = @event_code, \n       return_code = @return_code, \n       create_time = @create_time, \n       update_time = @update_time, \n       reply_content = @reply_content, \n       reply_time = @reply_time, \n       status = @status, \n       gateway_id = @gateway_id, \n       code = @code \nWHERE  uid = @uid\n\n","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_record_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_record_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_date","type":"VarChar(?)","valueType":"msg","value":"payload.tx_date","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"tx_time","type":"VarChar(?)","valueType":"msg","value":"payload.tx_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"event_code","type":"VarChar(?)","valueType":"msg","value":"payload.event_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_content","type":"VarChar(?)","valueType":"msg","value":"payload.reply_content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"reply_time","type":"DateTime2","valueType":"msg","value":"payload.reply_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"TinyInt","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"code","type":"VarChar(?)","valueType":"msg","value":"payload.code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1620,"y":2620,"wires":[["f8a7b247.7ab3","edccd466.e584a8"]]},{"id":"8a19cacd.2d553","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2450,"y":2560,"wires":[]},{"id":"a9d09a84.2fb948","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2200,"y":2620,"wires":[["8a19cacd.2d553","e2fd5ba0.377f28"],[]]},{"id":"f8a7b247.7ab3","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1940,"y":2520,"wires":[]},{"id":"e2fd5ba0.377f28","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2430,"y":2620,"wires":[]},{"id":"edccd466.e584a8","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Update Report DB send_record_reply table failure: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1940,"y":2620,"wires":[["a9d09a84.2fb948","72cce62b.50099"]]},{"id":"2c073942.f1732e","type":"function","z":"7153aef6.c56e78","name":"Convert Delete SendRecordReply Payload","func":"\n\nfunction convert_uuid(value) {\n    \n  if (value == null) { return null }\n\n  let source = value;\n  let raw = new Buffer.alloc(16, source, 'base64');\n\n  let p1 = raw.subarray(0, 4);\n  let p2 = raw.subarray(4, 6);\n  let p3 = raw.subarray(6, 8);\n  let p4 = raw.subarray(8, 10);\n  let p5 = raw.subarray(10);\n\n  let uuidArr = [\n  p1.swap32().toString('hex'),\n  p2.swap16().toString('hex'),\n  p3.swap16().toString('hex'),\n  p4.toString('hex'),\n  p5.toString('hex')\n  ];\n  \n  return uuidArr.join('-');\n\n}\n\nmsg.payload = msg.payload.payload;\nmsg.payload.uid= convert_uuid(msg.payload.uid)\nmsg.payload2 = msg.payload\n\nmsg.send_record_reply_table_uid = msg.payload.uid\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":2820,"wires":[["87090bbb.4fff58","b9a1a517.2d0cc"]]},{"id":"87090bbb.4fff58","type":"debug","z":"7153aef6.c56e78","name":"Debug Send Record Reply Table","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload2","targetType":"msg","statusVal":"","statusType":"auto","x":1600,"y":2720,"wires":[]},{"id":"b9a1a517.2d0cc","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"35b0806c.4ac0e8","name":"Report SendRecordReply MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"DELETE from [NBPReport].[dbo].[send_record_reply] where uid=@uid","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1620,"y":2820,"wires":[["228fac8a.7cb24c","39a1d21d.dd3c0e"]]},{"id":"10ae5802.1e6968","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2490,"y":2760,"wires":[]},{"id":"ff149daf.545e3","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2240,"y":2820,"wires":[["10ae5802.1e6968","fba67401.ba232"],[]]},{"id":"228fac8a.7cb24c","type":"debug","z":"7153aef6.c56e78","name":"Debug MSSQL Error","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":1920,"y":2720,"wires":[]},{"id":"fba67401.ba232","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2470,"y":2820,"wires":[]},{"id":"39a1d21d.dd3c0e","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply for Success, UID:\" + msg.send_record_reply_table_uid \n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Delete Report DB send_record_reply table failure, MSG: \" + msg.error\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1980,"y":2820,"wires":[["ff149daf.545e3","8a550c45.6ab3c8"]]},{"id":"3e66e8a7.6a8e9","type":"debug","z":"7153aef6.c56e78","name":"Redis Result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":450,"y":3180,"wires":[]},{"id":"b8953d86.8827a","type":"redis-in","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"subscribe","name":"","topic":"gravity_kernel_report","obj":true,"timeout":"3","x":260,"y":3180,"wires":[["3e66e8a7.6a8e9"]]},{"id":"af3436c.734a5c8","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2200,"y":80,"wires":[]},{"id":"7531b7ef.6da068","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2080,"y":300,"wires":[]},{"id":"5545c2c1.36a0dc","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2060,"y":580,"wires":[]},{"id":"3d213895.ed5098","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2500,"y":1840,"wires":[]},{"id":"2bded10a.0a2636","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2240,"y":2320,"wires":[]},{"id":"72cce62b.50099","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2220,"y":2560,"wires":[]},{"id":"8a550c45.6ab3c8","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2200,"y":2720,"wires":[]},{"id":"ebfd1d89.e5ab8","type":"switch","z":"7153aef6.c56e78","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":840,"y":1560,"wires":[["f2161214.868e68"],["f2161214.868e68"],["a02b87a1.efadd"],["66a87ca8.7a2294"]]},{"id":"ba35f7d4.57351","type":"switch","z":"7153aef6.c56e78","name":"Check Created Event ","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"SendRecordReplyProductInitialize","vt":"str"},{"t":"eq","v":"SendRecordReplyProductCreate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductUpdate","vt":"str"},{"t":"eq","v":"SendRecordReplyProductDelete","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":760,"y":2620,"wires":[["546f56f1.65b2b"],["546f56f1.65b2b"],["2f72f315.8f9ef4"],["2c073942.f1732e"]]},{"id":"670fb898.5cd938","type":"debug","z":"7153aef6.c56e78","name":"Display Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":640,"y":1440,"wires":[]},{"id":"71381773.64bca8","type":"nats-streaming-subscribe","z":"7153aef6.c56e78","name":"Send Record","server":"81898769.b5aff8","channel":"rowData.source.SendProduct","clientID":"cache1-atomic-0001","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0002","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"30","x":130,"y":380,"wires":[["93a35271.26329"]]},{"id":"b38f4f2e.2803a8","type":"nats-streaming-subscribe","z":"7153aef6.c56e78","name":"Send Record Product","server":"81898769.b5aff8","channel":"rowData.source.SendRecordProduct","clientID":"cache-atomic-0002","start":"all","start_option":"","durable":true,"durable_name":"report-atomic-0003","queue_group":"","queue_group_name":"","autoacknowledge":false,"ackwait":"30","rate_limit":true,"max_in_flight":"30","x":140,"y":1560,"wires":[["90c9145b.bcb18"]]},{"id":"846bf59a.140d8","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"\nBEGIN\n\nBEGIN TRANSACTION;\n\nINSERT INTO [dbo].[SI_SinoPacBankMsgInfo] \n            (SerialNum, \n             GUID, \n             MPhoneNum, \n             MsgData, \n             Priority, \n             BookingTime, \n             DepID, \n             MsgType, \n             Memo, \n             SenderID, \n             Bu, \n             Company, \n             Channel, \n             Reference, \n             GroupID, \n             UserName, \n             SourceType, \n             ObjectID, \n             SerialNo, \n             DestNo, \n             DestName, \n             DestCategory, \n             OrderID, \n             MID, \n             SubmitTime, \n             OrderTime, \n             ExpireTime, \n             StatusFlag, \n             SubmitFlag, \n             Filler, \n             StatusTime, \n             BatchCode) \n (\n SELECT send_record.serial_number                                                                                                          AS SerialNum,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GUID,\n        send_record.customer_phone                                                                                                         AS MPhoneNum,\n        send_record.content                                                                                                                AS MsgData,\n        send.priority                                                                                                                      AS Priority,\n        CAST(send_record.send_time AS DATETIME)                                                                                            AS BookingTime,\n        send_record.req_department                                                                                                         AS DepID,\n        send.msg_type                                                                                                                      AS MsgType,\n        send.memo                                                                                                                          AS Memo,\n        send_record.customer_id                                                                                                            AS SenderID,\n        send_record.req_bu                                                                                                                 AS Bu,\n        send_record.req_company                                                                                                            AS Company,\n        send.req_channel                                                                                                                   AS Channel,\n        send_record.customer_reference                                                                                                     AS REFERENCE,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS GroupID,\n        substring(CONVERT(VARCHAR(36), send.create_user), 1, 20)                                                                           AS UserName,\n        ''                                                                                                                                 AS SourceType,\n        send_record.req_object_id                                                                                                          AS ObjectID,\n        CONVERT(VARCHAR(36), send_record.uid)                                                                                              AS SerialNo,\n        send_record.customer_phone                                                                                                         AS DestNo,\n        CONVERT(VARCHAR(36), send_record.req_uid)                                                                                          AS DestName,\n        send_record.req_department                                                                                                         AS DestCategory,\n        ''                                                                                                                                 AS OrderID,\n        ''                                                                                                                                 AS MID,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.actual_send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14) AS SubmitTime, \n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.send_time AS DATETIME),20),':',''),'-',''),' ',''),1,14)        AS OrderTime, \n        CAST(send_record.expire_time AS DATETIME)                                                                                          AS ExpireTime, \n        send_record.resp_code                                                                                                              AS StatusFlag,\n        ''                                                                                                                                 AS SubmitFlag,\n        ''                                                                                                                                 AS Filler,\n        substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,CAST(send_record.dr_time AS DATETIME ),20),':',''),'-',''),' ',''),1,14)         AS StatusTime, \n        send.req_batch_id                                                                                                                  AS BatchCode\n FROM   [dbo].[send_record]                                                                                                                AS send_record,\n        [dbo].[send]                                                                                                                       AS send\n WHERE  send_record.uid = @uid \n AND    send_record.send_uid = send.uid)        \n\nCOMMIT;\n\nEND","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1760,"y":1180,"wires":[["2163c9ec.426ff6"]]},{"id":"c3db96cf.a8a34","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2590,"y":1160,"wires":[]},{"id":"60d3cfb7.8de21","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2340,"y":1220,"wires":[["c3db96cf.a8a34","1ed9d3d5.5340d4"],[]]},{"id":"1ed9d3d5.5340d4","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2570,"y":1220,"wires":[]},{"id":"2163c9ec.426ff6","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB Success\"\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB Failure\"\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2080,"y":1220,"wires":[["60d3cfb7.8de21","5b26d46e.2c677c"]]},{"id":"5b26d46e.2c677c","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2360,"y":1140,"wires":[]},{"id":"420cec48.99a11c","type":"MSSQL","z":"7153aef6.c56e78","mssqlCN":"f04213fa.c22b48","name":"Cache SendRecord MSSQL","outField":"payload","returnType":0,"throwErrors":"0","query":"BEGIN\n\nBEGIN TRANSACTION;\n\nDECLARE @SerialNum int \nDECLARE @GUID char(36) \nDECLARE @MPhoneNum varchar(25) \nDECLARE @MsgData nvarchar(max) \nDECLARE @Priority tinyint \nDECLARE @BookingTime datetime \nDECLARE @ExpireTime datetime \nDECLARE @DepID varchar(8) \nDECLARE @MsgType varchar(5) \nDECLARE @Memo varchar(40) \nDECLARE @SenderID varchar(15) \nDECLARE @GroupID varchar(36) \nDECLARE @Bu char(6) \nDECLARE @Company char(6) \nDECLARE @Channel char(16) \nDECLARE @Reference char(64) \nDECLARE @UserName varchar(20) \nDECLARE @SourceType char(1) \nDECLARE @ObjectID varchar(36) \nDECLARE @SerialNo varchar(36) \nDECLARE @DestNo varchar(20) \nDECLARE @DestName varchar(36) \nDECLARE @DestCategory char(8) \nDECLARE @DelegateTime char(14) \nDECLARE @SubmitTime char(14) \nDECLARE @OrderID varchar(20) \nDECLARE @MID varchar(5) \nDECLARE @OrderTime char(14) \nDECLARE @StatusFlag char(1) \nDECLARE @SubmitFlag varchar(3) \nDECLARE @StatusTime char(14) \nDECLARE @BatchCode varchar(64)\nDECLARE @Filler varchar(5)\n\nSELECT @SerialNum = send_record.serial_number, \n       @GUID = convert(varchar(36), send_record.req_uid), \n       @MPhoneNum = send_record.customer_phone, \n       @MsgData = send_record.content, \n       @Priority = send.priority, \n       @BookingTime = send_record.send_time, \n       @DepID = send_record.req_department, \n       @MsgType = send.msg_type, \n       @Memo = send.memo, \n       @SenderID = send_record.customer_id, \n       @Bu = send_record.req_bu, \n       @Company = send_record.req_company, \n       @Channel = send.req_channel, \n       @Reference = send_record.customer_reference, \n       @GroupID = convert(varchar(36), send_record.req_uid), \n       @UserName = Substring(convert(varchar(36), send.create_user), 1, 20), \n       @SourceType = '', \n       @ObjectID = send_record.req_object_id, \n       @SerialNo = convert(varchar(36), send_record.uid), \n       @DestNo = send_record.customer_phone, \n       @DestName = convert(varchar(36), send_record.req_uid), \n       @DestCategory = send_record.req_department, \n       @OrderID = '', \n       @MID = '', \n       @SubmitTime = substring(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR,cast(send_record.actual_send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @OrderTime = substring(replace(replace(replace(convert(varchar,cast(send_record.send_time as datetime),20),':',''),'-',''),' ',''),1,14), \n       @ExpireTime = cast(send_record.expire_time as datetime),\n       @StatusFlag = send_record.resp_code, \n       @SubmitFlag = '', \n       @Filler = '', \n       @StatusTime = substring(replace(replace(replace(convert(varchar,cast(send_record.dr_time as datetime),20),':',''),'-',''),' ',''),1,14),\n       @BatchCode = send.req_batch_id\nFROM   [NBPReport].[dbo].[send_record] as send_record, \n       [NBPReport].[dbo].[send] as send \nWHERE  send_record.uid = @uid \n       AND send_record.send_uid = send.uid \n\n\nUPDATE [dbo].[SI_SinoPacBankMsgInfo]\nSET     SerialNum = @SerialNum,\n        MPhoneNum=@MPhoneNum ,\n        MsgData=@MsgData ,\n        Priority=@Priority,\n        BookingTime=@BookingTime ,\n        DepID=@DepID ,\n        MsgType=@MsgType,\n        Memo=@Memo ,\n        SenderID=@SenderID ,\n        Bu=@Bu ,\n        Company=@Company ,\n        Channel=@Channel ,\n        Reference=@Reference ,\n        GroupID=@GroupID ,\n        UserName=@UserName ,\n        SourceType=@SourceType ,\n        ObjectID=@ObjectID ,\n        SerialNo=@SerialNo,\n        DestNo=@DestNo ,\n        DestCategory=@DestCategory,\n        OrderID=@OrderID ,\n        MID=@MID ,\n        SubmitTime=@SubmitTime,\n        OrderTime=@OrderTime,\n        ExpireTime=@ExpireTime ,\n        StatusFlag=@StatusFlag ,\n        SubmitFlag=@SubmitFlag,\n        Filler=@Filler ,\n        StatusTime=@StatusTime,\n        BatchCode=@BatchCode\nWHERE GUID=@GUID\n\n\nCOMMIT;\n\nEND","modeOpt":"","modeOptType":"query","queryOpt":"","queryOptType":"editor","paramsOpt":"","paramsOptType":"editor","rows":"rows","rowsType":"msg","params":[{"output":false,"name":"uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_uid","type":"UniqueIdentifier","valueType":"msg","value":"payload.send_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"way_name","type":"VarChar(?)","valueType":"msg","value":"payload.way_name","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"serial_number","type":"Int","valueType":"msg","value":"payload.serial_number","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"send_time","type":"DateTime2","valueType":"msg","value":"payload.send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"expire_time","type":"DateTime2","valueType":"msg","value":"payload.expire_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_id","type":"VarChar(?)","valueType":"msg","value":"payload.customer_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_phone","type":"VarChar(?)","valueType":"msg","value":"payload.customer_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"customer_reference","type":"VarChar(?)","valueType":"msg","value":"payload.customer_reference","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_group_id","type":"VarChar(?)","valueType":"msg","value":"payload.req_group_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"req_uid","type":"VarChar(?)","valueType":"msg","value":"payload.req_uid","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"content","type":"NVarChar(?)","valueType":"msg","value":"payload.content","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"return_code","type":"VarChar(?)","valueType":"msg","value":"payload.return_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"calc_section","type":"TinyInt","valueType":"msg","value":"payload.calc_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sending_section","type":"TinyInt","valueType":"msg","value":"payload.sending_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section","type":"TinyInt","valueType":"msg","value":"payload.section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"success_section","type":"TinyInt","valueType":"msg","value":"payload.success_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"failure_section","type":"TinyInt","valueType":"msg","value":"payload.failure_section","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"section_status_list","type":"VarChar(?)","valueType":"msg","value":"payload.section_status_list","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_long","type":"TinyInt","valueType":"msg","value":"payload.is_long","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"is_international","type":"TinyInt","valueType":"msg","value":"payload.is_international","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"msg_id","type":"VarChar(?)","valueType":"msg","value":"payload.msg_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_time","type":"DateTime2","valueType":"msg","value":"payload.actual_send_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"actual_send_phone","type":"VarChar(?)","valueType":"msg","value":"payload.actual_send_phone","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gateway_id","type":"Int","valueType":"msg","value":"payload.gateway_id","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"status","type":"Int","valueType":"msg","value":"payload.status","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"gwrecvat","type":"VarChar(?)","valueType":"msg","value":"payload.gwrecvat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"acceptat","type":"VarChar(?)","valueType":"msg","value":"payload.acceptat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"sendat","type":"VarChar(?)","valueType":"msg","value":"payload.sendat","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"finish_time","type":"DateTime2","valueType":"msg","value":"payload.finish_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"meta","type":"NVarChar(?)","valueType":"msg","value":"payload.meta","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"create_time","type":"DateTime2","valueType":"msg","value":"payload.create_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_time","type":"DateTime2","valueType":"msg","value":"payload.update_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"deliver_time","type":"DateTime2","valueType":"msg","value":"payload.deliver_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"canceled_time","type":"DateTime2","valueType":"msg","value":"payload.canceled_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"dr_time","type":"DateTime2","valueType":"msg","value":"payload.dr_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"update_expired_time","type":"DateTime2","valueType":"msg","value":"payload.update_expired_time","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}},{"output":false,"name":"origin_resp_code","type":"VarChar(?)","valueType":"msg","value":"payload.origin_resp_code","options":{"nullable":true,"primary":false,"identity":false,"readOnly":false}}],"x":1800,"y":1660,"wires":[["3d890e2e.6f85aa"]]},{"id":"9dd0d780.70f24","type":"debug","z":"7153aef6.c56e78","name":"Log Result","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"result","targetType":"msg","statusVal":"","statusType":"auto","x":2630,"y":1480,"wires":[]},{"id":"fd9fb73c.a4f8e8","type":"switch","z":"7153aef6.c56e78","name":"Check DB Error","property":"have_error","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2380,"y":1540,"wires":[["9dd0d780.70f24","57297997.cc3498"],[]]},{"id":"57297997.cc3498","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"STAN ACK","x":2610,"y":1540,"wires":[]},{"id":"3d890e2e.6f85aa","type":"function","z":"7153aef6.c56e78","name":"Log Result  Information","func":"\nmsg.have_error = 0\n    \nif ( (typeof msg.error == 'undefined') || (msg.error == null) )  {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB Success\"\n} else {\n    msg.result = \"[GRAVITY][ATOMIC] Insert Cache DB Failure\"\n    msg.have_error = 1\n    \n}\n\nmsg.payload = {\n    \"code\": msg.have_error,\n    \"msg\": msg.result\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2120,"y":1540,"wires":[["fd9fb73c.a4f8e8","156719fa.c09af6"]]},{"id":"156719fa.c09af6","type":"redis-out","z":"7153aef6.c56e78","d":true,"server":"9610aff8.a70458","command":"publish","name":"","topic":"gravity_kernel_report","obj":true,"x":2400,"y":1460,"wires":[]},{"id":"93a35271.26329","type":"nats-streaming-acknowledge","z":"7153aef6.c56e78","name":"","x":390,"y":480,"wires":[]}]